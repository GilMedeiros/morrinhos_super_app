<!DOCTYPE html>
<html lang="pt-BR">
<!-- <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - Sistema PDF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/styles-fixed.css" rel="stylesheet">
</head> -->
<%- include('partials/header') %>
<body>
    <!-- Navigation -->
    <!-- <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-file-earmark-pdf me-2"></i>Sistema PDF</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-send me-1"></i>Criar Disparo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/upload"><i class="bi bi-plus-circle me-1"></i>Nova Lista</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/disparos"><i class="bi bi-list-check me-1"></i>Gerenciar Disparos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/configuracoes"><i class="bi bi-gear me-1"></i>Configura√ß√µes</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav> -->
<%- include('partials/nav') %>
    <!-- Main Content -->
    <div class="container-fluid mt-3">
        <!-- Header Section -->
        <div class="text-center mb-4">
            <div class="d-flex justify-content-center gap-3 align-items-center mb-3">
                <img src="img/conecta.png" alt="Logo Conecta" style="height: 40px;">
                <img src="img/morrinhos.png" alt="Logo Morrinhos" style="height: 40px;">
            </div>
        </div>

        <!-- Page Header -->
        <div class="row justify-content-center">
            <div class="col-lg-11">
                <div class="card main-card mb-4">
                    <div class="card-header text-center">
                        <h2 class="mb-1">
                            <i class="bi bi-gear-fill me-2"></i>
                            Configura√ß√µes do Sistema
                        </h2>
                        <p class="mb-0 opacity-75">Gerencie as configura√ß√µes globais do sistema</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typebot Configuration Panel -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-11">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-robot me-2"></i>
                            Configura√ß√£o do Endpoint
                        </h5>
                        <button class="btn btn-light btn-sm" data-bs-toggle="collapse" data-bs-target="#typebotConfig">
                            <i class="bi bi-gear-fill me-1"></i>Configurar
                        </button>
                    </div>
                    <div class="collapse show" id="typebotConfig">
                        <div class="card-body">
                            <!-- Configura√ß√µes da API -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-cloud-arrow-up me-2"></i>Configura√ß√µes da API
                                    </h6>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">URL do Endpoint:</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="typebotUrl" 
                                                   value="https://evo.apollocompany.com.br/typebot/start/4363_apollo" 
                                                   placeholder="https://api.exemplo.com/webhook">
                                            <button class="btn btn-outline-success" type="button" onclick="saveTypebotConfig()" title="Salvar configura√ß√µes">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted">URL completa do endpoint que receber√° as requisi√ß√µes HTTP</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">M√©todo HTTP:</label>
                                        <select class="form-select" id="httpMethod">
                                            <option value="POST" selected>POST</option>
                                            <option value="PUT">PUT</option>
                                            <option value="PATCH">PATCH</option>
                                        </select>
                                        <small class="text-muted">M√©todo HTTP para envio das requisi√ß√µes</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">API Key / Token:</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="typebotApiKey" 
                                                   value="8DAE19CC1DC5-430B-A005-5E4CDFEBB17E"
                                                   placeholder="Digite sua chave de API ou token">
                                            <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility()">
                                                <i class="bi bi-eye" id="eyeIcon"></i>
                                            </button>
                                            <button class="btn btn-outline-info" type="button" onclick="loadTypebotConfig()" title="Recarregar configura√ß√µes">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted">Token de autentica√ß√£o (enviado como Authorization: Bearer)</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Headers Personalizados:</label>
                                        <textarea class="form-control" id="customHeaders" rows="3" 
                                                  placeholder='{"Content-Type": "application/json", "X-Custom-Header": "valor"}'></textarea>
                                        <small class="text-muted">Headers adicionais em formato JSON (opcional)</small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary btn-sm" onclick="saveTypebotConfig()">
                                            <i class="bi bi-floppy me-1"></i>Salvar Configura√ß√µes
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="resetTypebotConfig()">
                                            <i class="bi bi-arrow-counterclockwise me-1"></i>Restaurar Padr√£o
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-info-circle me-2"></i>Status da Conex√£o
                                    </h6>
                                    <div class="border rounded p-3 bg-light mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span><strong>Status da API:</strong></span>
                                            <span id="apiStatus" class="badge bg-secondary">Verificando...</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span><strong>√öltimo Teste:</strong></span>
                                            <span id="lastApiTest" class="text-muted">-</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><strong>Tempo de Resposta:</strong></span>
                                            <span id="responseTime" class="text-muted">-</span>
                                        </div>
                                    </div>
                                    
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-code-square me-2"></i>Formato da Requisi√ß√£o
                                    </h6>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Template do Payload:</label>
                                        <div class="d-flex gap-2 mb-2">
                                            <button class="btn btn-sm btn-outline-info" onclick="loadDefaultPayloadTemplate()">
                                                <i class="bi bi-arrow-clockwise me-1"></i>Template Padr√£o
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="validatePayloadTemplate()">
                                                <i class="bi bi-check-circle me-1"></i>Validar JSON
                                            </button>
                                        </div>
                                        <textarea class="form-control font-monospace" id="payloadTemplate" rows="8" 
                                                  placeholder='{"phone": "{phone}", "name": "{name}", "agendamento": "{agendamento}", "procedimento": "{procedimento}"}'></textarea>
                                        <small class="text-muted">
                                            Use as vari√°veis: {phone}, {name}, {agendamento}, {procedimento}<br>
                                            Formato JSON que ser√° enviado para a API
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Teste Manual -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-play-circle me-2"></i>Teste Manual da Integra√ß√£o
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">N√∫mero de Telefone:</label>
                                                <input type="text" class="form-control" id="testPhone" 
                                                       placeholder="(21) 98333-0400" maxlength="15">
                                                <small class="text-muted">Formato: (DD) 9XXXX-XXXX</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Nome do Paciente:</label>
                                                <input type="text" class="form-control" id="testName" 
                                                       placeholder="Jo√£o Silva">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Procedimento:</label>
                                                <input type="text" class="form-control" id="testProcedimento" 
                                                       placeholder="Consulta Cardiol√≥gica">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Data e Hora do Agendamento:</label>
                                                <input type="datetime-local" class="form-control" id="testAgendamento">
                                            </div>
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <div class="d-flex gap-2 w-100">
                                                <button class="btn btn-info flex-fill" onclick="testTypebotConnection()">
                                                    <i class="bi bi-wifi me-1"></i>Testar Conectividade
                                                </button>
                                                <button class="btn btn-warning flex-fill" onclick="testManualMessage()">
                                                    <i class="bi bi-send me-1"></i>Enviar Teste
                                                </button>
                                                <button class="btn btn-secondary" onclick="fillTestData()">
                                                    <i class="bi bi-clipboard-data me-1"></i>Dados de Exemplo
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Logs de Teste -->
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-list-ul me-2"></i>Log de Testes
                                    </h6>
                                    <div class="border rounded p-3 bg-light" style="height: 200px; overflow-y: auto;">
                                        <div id="testLogs" class="font-monospace small">
                                            <div class="text-muted">Pronto para executar testes...</div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-2">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearTestLogs()">
                                            <i class="bi bi-trash me-1"></i>Limpar Logs
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Queue Configuration Panel -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-11">
                <div class="card border-info">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-gear-wide-connected me-2"></i>
                            Configura√ß√µes da Fila de Disparos
                        </h5>
                        <button class="btn btn-light btn-sm" data-bs-toggle="collapse" data-bs-target="#queueConfig">
                            <i class="bi bi-gear-fill me-1"></i>Configurar
                        </button>
                    </div>
                    <div class="collapse show" id="queueConfig">
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <h6 class="text-info mb-3">
                                        <i class="bi bi-clock me-2"></i>Configura√ß√µes de Intervalo
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Intervalo M√≠nimo (segundos):</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="queueMinInterval" 
                                                           value="20" min="5" max="300" placeholder="20">
                                                    <span class="input-group-text">seg</span>
                                                </div>
                                                <small class="text-muted">Tempo m√≠nimo entre requisi√ß√µes (m√≠nimo 5 segundos)</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Intervalo M√°ximo (segundos):</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="queueMaxInterval" 
                                                           value="30" min="5" max="300" placeholder="30">
                                                    <span class="input-group-text">seg</span>
                                                </div>
                                                <small class="text-muted">Tempo m√°ximo entre requisi√ß√µes</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">M√°ximo de Tentativas:</label>
                                                <select class="form-select" id="queueMaxRetries">
                                                    <option value="1">1 tentativa</option>
                                                    <option value="2">2 tentativas</option>
                                                    <option value="3" selected>3 tentativas</option>
                                                    <option value="4">4 tentativas</option>
                                                    <option value="5">5 tentativas</option>
                                                    <option value="10">10 tentativas</option>
                                                </select>
                                                <small class="text-muted">N√∫mero de tentativas para mensagens com erro</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Mensagens por Lote:</label>
                                                <select class="form-select" id="queueBatchSize">
                                                    <option value="1" selected>1 por vez</option>
                                                    <option value="2">2 por vez</option>
                                                    <option value="3">3 por vez</option>
                                                    <option value="5">5 por vez</option>
                                                </select>
                                                <small class="text-muted">Quantas mensagens processar simultaneamente</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-info btn-sm" onclick="saveQueueConfig()">
                                            <i class="bi bi-floppy me-1"></i>Salvar Configura√ß√µes
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="loadQueueConfig()">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Recarregar
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="resetQueueConfig()">
                                            <i class="bi bi-arrow-counterclockwise me-1"></i>Restaurar Padr√£o
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-info mb-3">
                                        <i class="bi bi-info-circle me-2"></i>Informa√ß√µes
                                    </h6>
                                    <div class="border rounded p-3 bg-light">
                                        <div class="mb-3">
                                            <h6 class="text-primary">Como Funciona:</h6>
                                            <ul class="small mb-0">
                                                <li>A fila processa mensagens automaticamente</li>
                                                <li>O intervalo entre mensagens √© aleat√≥rio</li>
                                                <li>Varia entre o m√≠nimo e m√°ximo configurado</li>
                                                <li>Mensagens com erro s√£o tentadas novamente</li>
                                            </ul>
                                        </div>
                                        <div class="mb-3">
                                            <h6 class="text-warning">Recomenda√ß√µes:</h6>
                                            <ul class="small mb-0">
                                                <li>M√≠nimo: 20 segundos para n√£o sobrecarregar</li>
                                                <li>M√°ximo: 30-60 segundos para distribuir carga</li>
                                                <li>Tentativas: 3 √© um bom equil√≠brio</li>
                                                <li>Lote: 1 por vez √© mais est√°vel</li>
                                            </ul>
                                        </div>
                                        <div class="alert alert-warning alert-sm p-2 mb-0">
                                            <small>
                                                <i class="bi bi-exclamation-triangle me-1"></i>
                                                Alterar configura√ß√µes reinicia a fila automaticamente
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Queue Control Panel -->
        <!-- <div class="row justify-content-center mb-4">
            <div class="col-lg-11">
                <div class="card border-success">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list-task me-2"></i>
                            Controle da Fila de Disparos
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-light btn-sm" id="btnStartQueue">
                                <i class="bi bi-play-fill me-1"></i>Iniciar Fila
                            </button>
                            <button class="btn btn-danger btn-sm" id="btnStopQueue">
                                <i class="bi bi-stop-fill me-1"></i>Parar Fila
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="refreshQueueStatus()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div id="queueInfo" class="border rounded p-3 bg-light">
                                    <h6 class="text-success mb-3">Status da Fila</h6>
                                    <p class="mb-2"><strong>Status:</strong> <span id="queueStatusText" class="badge bg-secondary">Carregando...</span></p>
                                    <p class="mb-2"><strong>Intervalo:</strong> <span id="queueInterval">20-30 segundos</span></p>
                                    <p class="mb-0"><strong>M√°x. Tentativas:</strong> <span id="queueMaxRetries">3</span></p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div id="queueStats" class="border rounded p-3 bg-light">
                                    <h6 class="text-info mb-3">Estat√≠sticas</h6>
                                    <p class="mb-2"><strong>Na Fila:</strong> <span id="filaPendentes" class="badge bg-info">0</span></p>
                                    <p class="mb-2"><strong>Enviadas:</strong> <span id="filaEnviadas" class="badge bg-success">0</span></p>
                                    <p class="mb-0"><strong>Erro:</strong> <span id="filaErros" class="badge bg-danger">0</span></p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div id="queueProgress" class="border rounded p-3 bg-light">
                                    <h6 class="text-warning mb-3">Progresso</h6>
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between">
                                            <small>Processamento</small>
                                            <small id="progressPercent">0%</small>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <p class="mb-0 small"><strong>Pr√≥ximo Envio:</strong> <span id="nextSend">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> -->
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript Customizado -->
    <script>
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            loadTypebotConfig(); // Carregar configura√ß√µes do Typebot
            loadQueueConfig(); // Carregar configura√ß√µes da fila
            loadQueueStatus(); // Carregar status da fila
            
            // Setup Event Listeners
            setupEventListeners();
        });
        
        // Configurar event listeners
        function setupEventListeners() {
            // Event listeners para bot√µes da fila
            const btnStartQueue = document.getElementById('btnStartQueue');
            const btnStopQueue = document.getElementById('btnStopQueue');
            
            if (btnStartQueue) {
                btnStartQueue.addEventListener('click', startQueue);
            }
            
            if (btnStopQueue) {
                btnStopQueue.addEventListener('click', stopQueue);
            }
            
            // Outros event listeners podem ser configurados aqui
        }

        // Fun√ß√µes de Controle da Fila
        async function startQueue() {
            try {
                const response = await fetch('/api/disparos/queue/start', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    mostrarToast('Fila de disparos iniciada com sucesso!', 'success');
                    loadQueueStatus();
                } else {
                    mostrarToast('Erro ao iniciar fila: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Erro ao iniciar fila:', error);
                mostrarToast('Erro ao iniciar fila: ' + error.message, 'danger');
            }
        }

        async function stopQueue() {
            try {
                const response = await fetch('/api/disparos/queue/stop', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    mostrarToast('Fila de disparos parada com sucesso!', 'success');
                    loadQueueStatus();
                } else {
                    mostrarToast('Erro ao parar fila: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Erro ao parar fila:', error);
                mostrarToast('Erro ao parar fila: ' + error.message, 'danger');
            }
        }

        // Carregar configura√ß√µes do Typebot
        async function loadTypebotConfig() {
            try {
                addTestLog('üì• Carregando configura√ß√µes do Webhook...', 'info');
                
                const response = await fetch('/api/typebot/config');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const config = data.data;
                    document.getElementById('typebotUrl').value = config.url || '';
                    document.getElementById('typebotApiKey').value = config.apiKey || '';
                    document.getElementById('httpMethod').value = config.httpMethod || 'POST';
                    document.getElementById('customHeaders').value = config.customHeaders ? JSON.stringify(config.customHeaders, null, 2) : '';
                    document.getElementById('payloadTemplate').value = config.payloadTemplate || getDefaultPayloadTemplate();
                    
                    // Validar template carregado
                    validatePayloadTemplate();
                    
                    addTestLog('‚úÖ Configura√ß√µes carregadas com sucesso', 'success');
                    updateApiStatus('online', 'Configura√ß√µes carregadas');
                } else {
                    throw new Error(data.message || 'Erro ao carregar configura√ß√µes');
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
                addTestLog('‚ùå Erro ao carregar configura√ß√µes: ' + error.message, 'error');
                updateApiStatus('offline', 'Erro ao carregar');
                
                // Carregar configura√ß√µes padr√£o em caso de erro
                loadDefaultConfig();
            }
        }

        // Carregar configura√ß√µes padr√£o
        function loadDefaultConfig() {
            document.getElementById('typebotUrl').value = 'https://evo.apollocompany.com.br/typebot/start/4363_apollo';
            document.getElementById('typebotApiKey').value = '8DAE19CC1DC5-430B-A005-5E4CDFEBB17E';
            document.getElementById('httpMethod').value = 'POST';
            document.getElementById('customHeaders').value = '';
            document.getElementById('payloadTemplate').value = getDefaultPayloadTemplate();
            
            // Validar template padr√£o
            validatePayloadTemplate();
        }

        // Obter template padr√£o do payload
        function getDefaultPayloadTemplate() {
            return JSON.stringify({
                phone: "{phone}",
                name: "{name}",
                agendamento: "{agendamento}",
                procedimento: "{procedimento}",
                test: false
            }, null, 2);
        }

        // Carregar template padr√£o do payload
        function loadDefaultPayloadTemplate() {
            const payloadTemplate = document.getElementById('payloadTemplate');
            payloadTemplate.value = getDefaultPayloadTemplate();
            
            // Validar o template carregado
            validatePayloadTemplate();
            
            addTestLog('üìÑ Template padr√£o carregado', 'info');
            mostrarToast('Template padr√£o carregado!', 'info');
        }

        // Salvar configura√ß√µes do Typebot
        async function saveTypebotConfig() {
            const url = document.getElementById('typebotUrl').value.trim();
            const apiKey = document.getElementById('typebotApiKey').value.trim();
            const httpMethod = document.getElementById('httpMethod').value;
            const customHeaders = document.getElementById('customHeaders').value.trim();
            const payloadTemplate = document.getElementById('payloadTemplate').value.trim();
            
            if (!url || !apiKey) {
                mostrarToast('Por favor, preencha a URL e a API Key', 'warning');
                return;
            }
            
            // Validar headers customizados se preenchidos
            let parsedHeaders = {};
            if (customHeaders) {
                try {
                    parsedHeaders = JSON.parse(customHeaders);
                } catch (error) {
                    mostrarToast('Headers personalizados devem estar em formato JSON v√°lido', 'danger');
                    return;
                }
            }
            
            try {
                addTestLog('üíæ Salvando configura√ß√µes...', 'info');
                
                const response = await fetch('/api/typebot/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url,
                        apiKey,
                        httpMethod,
                        customHeaders: parsedHeaders,
                        payloadTemplate
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    addTestLog('‚úÖ Configura√ß√µes salvas com sucesso', 'success');
                    mostrarToast('Configura√ß√µes do Typebot salvas com sucesso!', 'success');
                } else {
                    throw new Error(data.message || 'Erro ao salvar configura√ß√µes');
                }
                
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes:', error);
                addTestLog('‚ùå Erro ao salvar configura√ß√µes: ' + error.message, 'error');
                mostrarToast('Erro ao salvar configura√ß√µes: ' + error.message, 'danger');
            }
        }

        // Carregar configura√ß√µes da fila
        async function loadQueueConfig() {
            try {
                const response = await fetch('/api/disparos/queue/config');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const config = data.data;
                    
                    // Preencher campos
                    document.getElementById('queueMinInterval').value = config.minInterval / 1000;
                    document.getElementById('queueMaxInterval').value = config.maxInterval / 1000;
                    document.getElementById('queueMaxRetries').value = config.maxRetries;
                    document.getElementById('queueBatchSize').value = config.batchSize;
                    
                    console.log('Configura√ß√µes da fila carregadas:', config);
                } else {
                    console.error('Erro ao carregar configura√ß√µes da fila:', data.message);
                    mostrarToast('Erro ao carregar configura√ß√µes da fila', 'danger');
                }
                
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes da fila:', error);
                mostrarToast('Erro ao carregar configura√ß√µes da fila', 'danger');
            }
        }

        // Salvar configura√ß√µes da fila
        async function saveQueueConfig() {
            try {
                const minInterval = parseInt(document.getElementById('queueMinInterval').value) * 1000;
                const maxInterval = parseInt(document.getElementById('queueMaxInterval').value) * 1000;
                const maxRetries = parseInt(document.getElementById('queueMaxRetries').value);
                const batchSize = parseInt(document.getElementById('queueBatchSize').value);

                // Valida√ß√µes b√°sicas
                if (minInterval < 5000) {
                    mostrarToast('Intervalo m√≠nimo deve ser pelo menos 5 segundos', 'danger');
                    return;
                }
                
                if (maxInterval < minInterval) {
                    mostrarToast('Intervalo m√°ximo deve ser maior ou igual ao m√≠nimo', 'danger');
                    return;
                }
                
                const response = await fetch('/api/disparos/queue/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        minInterval,
                        maxInterval,
                        maxRetries,
                        batchSize
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    mostrarToast('Configura√ß√µes da fila salvas com sucesso!', 'success');
                    loadQueueStatus(); // Atualizar status ap√≥s salvar
                } else {
                    throw new Error(data.message || 'Erro ao salvar configura√ß√µes da fila');
                }
                
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes da fila:', error);
                mostrarToast('Erro ao salvar configura√ß√µes da fila: ' + error.message, 'danger');
            }
        }

        // Restaurar configura√ß√µes padr√£o da fila
        async function resetQueueConfig() {
            try {
                if (!confirm('Tem certeza que deseja restaurar as configura√ß√µes padr√£o da fila?')) {
                    return;
                }
                
                const response = await fetch('/api/disparos/queue/config/reset', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    mostrarToast('Configura√ß√µes da fila restauradas para o padr√£o', 'success');
                    loadQueueConfig();
                    loadQueueStatus();
                } else {
                    throw new Error(data.message || 'Erro ao restaurar configura√ß√µes da fila');
                }
                
            } catch (error) {
                console.error('Erro ao restaurar configura√ß√µes da fila:', error);
                mostrarToast('Erro ao restaurar configura√ß√µes da fila: ' + error.message, 'danger');
            }
        }

        // Carregar status da fila
        async function loadQueueStatus() {
            try {
                const response = await fetch('/api/disparos/queue/status');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateQueueStatusUI(data.data);
                } else {
                    console.error('Erro ao carregar status da fila:', data.message);
                }
            } catch (error) {
                console.error('Erro ao carregar status da fila:', error);
            }
        }

        // Atualizar interface do status da fila
        function updateQueueStatusUI(status) {
            // Status da fila
            const queueStatusText = document.getElementById('queueStatusText');
            const btnStartQueue = document.getElementById('btnStartQueue');
            const btnStopQueue = document.getElementById('btnStopQueue');
            
            if (status.active) {
                queueStatusText.textContent = 'Ativa';
                queueStatusText.className = 'badge bg-success';
                
                if (btnStartQueue && btnStopQueue) {
                    btnStartQueue.disabled = true;
                    btnStopQueue.disabled = false;
                }
            } else {
                queueStatusText.textContent = 'Parada';
                queueStatusText.className = 'badge bg-danger';
                
                if (btnStartQueue && btnStopQueue) {
                    btnStartQueue.disabled = false;
                    btnStopQueue.disabled = true;
                }
            }
            
            // Intervalo
            document.getElementById('queueInterval').textContent = `${status.config.minInterval/1000}-${status.config.maxInterval/1000} segundos`;
            document.getElementById('queueMaxRetries').textContent = status.config.maxRetries;
            
            // Estat√≠sticas
            document.getElementById('filaPendentes').textContent = status.stats.pending || '0';
            document.getElementById('filaEnviadas').textContent = status.stats.sent || '0';
            document.getElementById('filaErros').textContent = status.stats.errors || '0';
            
            // Progresso
            const total = (status.stats.pending || 0) + (status.stats.sent || 0) + (status.stats.errors || 0);
            const processed = (status.stats.sent || 0) + (status.stats.errors || 0);
            const percent = total > 0 ? Math.round((processed / total) * 100) : 0;
            
            document.getElementById('progressPercent').textContent = `${percent}%`;
            document.getElementById('progressBar').style.width = `${percent}%`;
            
            // Pr√≥ximo envio
            if (status.active && status.nextSendTime) {
                // Formatar pr√≥ximo envio
                const nextDate = new Date(status.nextSendTime);
                document.getElementById('nextSend').textContent = nextDate.toLocaleTimeString('pt-BR');
            } else {
                document.getElementById('nextSend').textContent = '-';
            }
        }

        // Atualizar manualmente o status da fila
        function refreshQueueStatus() {
            loadQueueStatus();
            mostrarToast('Status da fila atualizado', 'info');
        }

        // Fun√ß√£o para alternar visibilidade da API Key
        function toggleApiKeyVisibility() {
            const input = document.getElementById('typebotApiKey');
            const icon = document.getElementById('eyeIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('bi-eye', 'bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('bi-eye-slash', 'bi-eye');
            }
        }

        // Validar template do payload
        function validatePayloadTemplate() {
            const textarea = document.getElementById('payloadTemplate');
            const template = textarea.value.trim();
            
            if (!template) {
                textarea.classList.remove('is-valid', 'is-invalid');
                return false;
            }
            
            try {
                // Primeiro tentar fazer parse direto (pode ter vari√°veis que n√£o s√£o JSON v√°lido)
                try {
                    JSON.parse(template);
                    textarea.classList.add('is-valid');
                    textarea.classList.remove('is-invalid');
                    addTestLog('‚úÖ Template validado com sucesso', 'success');
                    return true;
                } catch {
                    // Substituir vari√°veis por valores de teste
                    const testTemplate = template
                        .replace(/\{phone\}/g, '"123456789"')
                        .replace(/\{name\}/g, '"Test Name"')
                        .replace(/\{agendamento\}/g, '"2023-01-01T10:00:00"')
                        .replace(/\{procedimento\}/g, '"Test Procedure"');
                    
                    // Tentar parse novamente
                    JSON.parse(testTemplate);
                    textarea.classList.add('is-valid');
                    textarea.classList.remove('is-invalid');
                    addTestLog('‚úÖ Template validado com sucesso (com vari√°veis)', 'success');
                    return true;
                }
            } catch (error) {
                textarea.classList.add('is-invalid');
                textarea.classList.remove('is-valid');
                addTestLog('‚ùå Erro de sintaxe JSON: ' + error.message, 'error');
                return false;
            }
        }

        // Testar conex√£o com o Typebot
        async function testTypebotConnection() {
            try {
                // Atualizar UI
                addTestLog('üîÑ Testando conex√£o com o endpoint...', 'info');
                updateApiStatus('testing', 'Testando...');
                
                const startTime = Date.now();
                
                // Fazer requisi√ß√£o de teste
                const response = await fetch('/api/typebot/test', {
                    method: 'POST'
                });
                
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                // Atualizar status com base na resposta
                if (data.status === 'success') {
                    updateApiStatus('online', responseTime + 'ms');
                    addTestLog(`‚úÖ Conex√£o bem sucedida (${responseTime}ms)`, 'success');
                    addTestLog(`üìä Resposta: ${data.message}`, 'info');
                } else {
                    updateApiStatus('error', data.message);
                    addTestLog(`‚ùå Erro na conex√£o: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao testar conex√£o:', error);
                updateApiStatus('error', error.message);
                addTestLog(`‚ùå Erro ao testar conex√£o: ${error.message}`, 'error');
            }
        }

        // Enviar mensagem de teste
        async function testManualMessage() {
            try {
                // Obter valores dos campos com verifica√ß√£o de exist√™ncia
                const phoneElement = document.getElementById('testPhone');
                const nameElement = document.getElementById('testName');
                const procedimentoElement = document.getElementById('testProcedimento');
                const agendamentoElement = document.getElementById('testAgendamento');
                
                // Verificar se os elementos existem
                if (!phoneElement || !nameElement || !procedimentoElement || !agendamentoElement) {
                    addTestLog('‚ùå Erro: Elementos do formul√°rio n√£o encontrados', 'error');
                    mostrarToast('Erro interno: Elementos do formul√°rio n√£o encontrados', 'danger');
                    return;
                }
                
                // Obter valores dos campos
                const phone = phoneElement.value.trim();
                const name = nameElement.value.trim();
                const procedimento = procedimentoElement.value.trim();
                const agendamento = agendamentoElement.value;
                
                addTestLog(`üîç Debug - Valores obtidos:`, 'info');
                addTestLog(`  üì± Telefone: "${phone}"`, 'info');
                addTestLog(`  üë§ Nome: "${name}"`, 'info');
                addTestLog(`  üè• Procedimento: "${procedimento}"`, 'info');
                addTestLog(`  üìÖ Agendamento: "${agendamento}"`, 'info');
                
                // Validar campos
                if (!phone || !name || !procedimento || !agendamento) {
                    addTestLog('‚ö†Ô∏è Preencha todos os campos para testar', 'warning');
                    mostrarToast('Preencha todos os campos para testar', 'warning');
                    return;
                }
                
                // Preparar dados para envio
                const phoneNumeric = phone.replace(/\D/g, '');
                
                // Validar se o telefone tem pelo menos 10 d√≠gitos
                if (phoneNumeric.length < 10) {
                    addTestLog('‚ö†Ô∏è N√∫mero de telefone deve ter pelo menos 10 d√≠gitos', 'warning');
                    mostrarToast('N√∫mero de telefone inv√°lido', 'warning');
                    return;
                }
                
                addTestLog(`üîÑ Enviando teste para ${phone}...`, 'info');
                addTestLog(`üì± Telefone num√©rico: "${phoneNumeric}"`, 'info');
                
                // Preparar payload no formato esperado pela API
                const payload = {
                    phone: phoneNumeric,
                    variables: {
                        name: name,
                        procedimento: procedimento,
                        agendamento: agendamento
                    }
                };
                
                addTestLog(`üì¶ Payload: ${JSON.stringify(payload, null, 2)}`, 'info');
                
                // Fazer requisi√ß√£o
                const response = await fetch('/api/typebot/test-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                addTestLog(`üì° Status HTTP: ${response.status}`, 'info');
                
                const data = await response.json();
                addTestLog(`üì® Resposta completa: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (response.ok && data.status === 'success') {
                    addTestLog('‚úÖ Mensagem de teste enviada com sucesso!', 'success');
                    mostrarToast('Mensagem de teste enviada com sucesso!', 'success');
                    
                    // Mostrar resposta da API
                    if (data.data) {
                        addTestLog(`üìä Dados da resposta: ${JSON.stringify(data.data, null, 2)}`, 'info');
                    }
                } else {
                    const errorMsg = data.message || data.error || `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMsg);
                }
                
            } catch (error) {
                console.error('Erro ao enviar mensagem de teste:', error);
                addTestLog(`‚ùå Erro ao enviar mensagem: ${error.message}`, 'error');
                mostrarToast('Erro ao enviar mensagem de teste: ' + error.message, 'danger');
            }
        }

        // Preencher dados de exemplo
        function fillTestData() {
            try {
                const phoneElement = document.getElementById('testPhone');
                const nameElement = document.getElementById('testName');
                const procedimentoElement = document.getElementById('testProcedimento');
                const agendamentoElement = document.getElementById('testAgendamento');
                
                if (!phoneElement || !nameElement || !procedimentoElement || !agendamentoElement) {
                    addTestLog('‚ùå Erro: Elementos n√£o encontrados para preencher dados', 'error');
                    return;
                }
                
                phoneElement.value = '(21) 98333-0400';
                nameElement.value = 'Jo√£o Silva';
                procedimentoElement.value = 'Consulta Cardiol√≥gica';
                
                // Data para amanh√£ √†s 14:00
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(14, 0, 0, 0);
                
                const dateTimeString = tomorrow.toISOString().slice(0, 16);
                agendamentoElement.value = dateTimeString;
                
                addTestLog('üìù Dados de exemplo preenchidos:', 'info');
                addTestLog(`  üì± Telefone: "${phoneElement.value}"`, 'info');
                addTestLog(`  üë§ Nome: "${nameElement.value}"`, 'info');
                addTestLog(`  üè• Procedimento: "${procedimentoElement.value}"`, 'info');
                addTestLog(`  üìÖ Agendamento: "${dateTimeString}"`, 'info');
                
            } catch (error) {
                addTestLog(`‚ùå Erro ao preencher dados: ${error.message}`, 'error');
            }
        }

        // Atualizar o status da API
        function updateApiStatus(status, message) {
            const apiStatusElement = document.getElementById('apiStatus');
            const lastTestElement = document.getElementById('lastApiTest');
            const responseTimeElement = document.getElementById('responseTime');
            
            if (apiStatusElement) {
                switch (status) {
                    case 'online':
                        apiStatusElement.textContent = 'Online';
                        apiStatusElement.className = 'badge bg-success';
                        break;
                    case 'offline':
                        apiStatusElement.textContent = 'Offline';
                        apiStatusElement.className = 'badge bg-danger';
                        break;
                    case 'error':
                        apiStatusElement.textContent = 'Erro';
                        apiStatusElement.className = 'badge bg-danger';
                        break;
                    case 'testing':
                        apiStatusElement.textContent = 'Testando...';
                        apiStatusElement.className = 'badge bg-warning';
                        break;
                    default:
                        apiStatusElement.textContent = 'Desconhecido';
                        apiStatusElement.className = 'badge bg-secondary';
                }
            }
            
            if (lastTestElement) {
                lastTestElement.textContent = new Date().toLocaleTimeString('pt-BR');
            }
            
            if (message && responseTimeElement) {
                responseTimeElement.textContent = message;
            }
        }

        // Adicionar log de teste
        function addTestLog(message, type = 'info') {
            const logsContainer = document.getElementById('testLogs');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            
            const logEntry = document.createElement('div');
            logEntry.className = `mb-1 ${getLogClass(type)}`;
            logEntry.innerHTML = `<small>[${timestamp}] ${message}</small>`;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Obter classe CSS para o log
        function getLogClass(type) {
            switch (type) {
                case 'success': return 'text-success';
                case 'error': return 'text-danger';
                case 'warning': return 'text-warning';
                case 'info': return 'text-info';
                default: return 'text-muted';
            }
        }

        // Limpar logs de teste
        function clearTestLogs() {
            document.getElementById('testLogs').innerHTML = '<div class="text-muted">Logs limpos. Pronto para novos testes...</div>';
        }

        // Mostrar toast
        function mostrarToast(mensagem, tipo = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${tipo}`;
            toast.style.animation = 'slideInRight 0.3s ease-out';
            
            const iconClass = tipo === 'success' ? 'bi-check-circle-fill' : 
                             tipo === 'danger' ? 'bi-exclamation-triangle-fill' : 
                             'bi-info-circle-fill';
                             
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi ${iconClass} me-2"></i>
                    <span>${mensagem}</span>
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remover ap√≥s 5 segundos
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }
    </script>
</body>
</html>
