<!DOCTYPE html>
<html lang="pt-BR">
<!-- <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparo - Sistema PDF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/styles-simple.css" rel="stylesheet">
</head> -->
<%- include('partials/header') %>
<style>
    /* Estilo para colunas de ordenação */
    th[onclick] {
        transition: background-color 0.2s ease;
    }
    
    th[onclick]:hover {
        background-color: rgba(0, 123, 255, 0.1) !important;
    }
    
    /* Estilo para ícones de ordenação */
    #iconeOrdenacao {
        font-size: 0.8em;
        transition: color 0.2s ease;
    }
    
    /* Indicador visual de que a coluna é clicável */
    th[onclick]::after {
        content: "";
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        opacity: 0.3;
    }
</style>
<body>
    <!-- Navigation -->
    <!-- <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-file-earmark-pdf me-2"></i>Sistema PDF</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/"><i class="bi bi-send me-1"></i>Criar Disparo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/upload"><i class="bi bi-plus-circle me-1"></i>Nova Lista</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/disparos"><i class="bi bi-list-check me-1"></i>Gerenciar Disparos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/configuracoes"><i class="bi bi-gear me-1"></i>Configurações</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav> -->
<%- include('partials/nav') %>
    <!-- Main Content -->
    <div class="container-fluid mt-3">
        <!-- Header Section -->
        <div class="text-center mb-4">
            <div class="d-flex justify-content-center gap-3 align-items-center mb-3">
                <img src="img/conecta.png" alt="Logo Conecta" style="height: 40px;">
                <img src="img/morrinhos.png" alt="Logo Morrinhos" style="height: 40px;">
            </div>
        </div>

        <!-- Page Header -->
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card main-card mb-4">
                    <div class="card-header text-center">
                        <h2 class="mb-1">
                            <i class="bi bi-send me-2"></i>
                            Listas de Disparo
                        </h2>
                        <p class="mb-0 opacity-75">Gerencie suas listas de solicitações processadas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Stats -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar por nome da lista...">
                                </div>
                            </div>
                            <div class="col-md-2 text-center mt-2 mt-md-0">
                                <a href="/upload" class="btn btn-success btn-sm w-100">
                                    <i class="bi bi-plus-circle me-1"></i>
                                    Nova Lista
                                </a>
                            </div>
                            <div class="col-md-6 text-md-end mt-2 mt-md-0">
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all" checked>
                                    <label class="btn btn-outline-primary btn-sm" for="filterAll">Todas</label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterReady" value="Pronto para Disparo">
                                    <label class="btn btn-outline-success btn-sm" for="filterReady">Prontas</label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterProgress" value="Disparos em Andamento">
                                    <label class="btn btn-outline-warning btn-sm" for="filterProgress">Em Andamento</label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterPending" value="Aguardando Disparo">
                                    <label class="btn btn-outline-secondary btn-sm" for="filterPending">Aguardando</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div class="row justify-content-center" id="loadingState">
            <div class="col-lg-10">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-muted">Carregando listas...</p>
                </div>
            </div>
        </div>

        <!-- Sources Grid -->
        <div class="row justify-content-center d-none" id="sourcesContainer">
            <div class="col-lg-10">
                <div class="row" id="sourcesGrid">
                    <!-- Sources will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="row justify-content-center d-none" id="emptyState">
            <div class="col-lg-6">
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h3 class="mt-3">Nenhuma lista encontrada</h3>
                    <p class="text-muted">Ainda não há listas de PDFs processados.</p>
                    <a href="/upload" class="btn btn-custom">
                        <i class="bi bi-plus-circle me-2"></i>
                        Criar Nova Lista
                    </a>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div class="row justify-content-center d-none" id="errorState">
            <div class="col-lg-6">
                <div class="result-card result-error text-center">
                    <i class="bi bi-exclamation-triangle display-4 mb-3"></i>
                    <h4>Erro ao carregar listas</h4>
                    <p id="errorMessage" class="mb-3">Ocorreu um erro ao buscar as listas.</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-custom" onclick="loadSources()">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            Tentar Novamente
                        </button>
                        <a href="/upload" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i>
                            Criar Nova Lista
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuração de Disparo -->
    <div class="modal fade modal-config-disparo" id="modalConfigurarDisparo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                        <h5 class="modal-title mb-0">
                            <i class="bi bi-gear me-2"></i>
                            Configurar Disparo - <span id="modalSourceName"></span>
                        </h5>
                        <div class="d-flex gap-3 text-sm">
                            <span class="badge bg-primary" id="totalItensSource">0 itens</span>
                            <span class="badge bg-success" id="totalFiltrados">0 filtrados</span>
                            <span class="badge bg-warning" id="totalSelecionadosHeader">0 selecionados</span>
                            <span class="badge bg-info d-none" id="filtroDataAtivo">
                                <i class="bi bi-calendar-range me-1"></i>
                                Filtro Data
                            </span>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Buscar</label>
                            <input type="text" class="form-control form-control-sm" id="searchSolicitacoes" placeholder="Buscar paciente...">
                        </div>
                        <!-- <div class="col-md-3">
                            <label class="form-label">Situação</label>
                            <select class="form-select form-select-sm" id="filterSituacao">
                                <option value="">Todas</option>
                            </select>
                        </div> -->
                        <div class="col-md-3">
                            <label class="form-label">Status Disparo</label>
                            <select class="form-select form-select-sm" id="filterStatusDisparo">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Classificação de Risco</label>
                            <select class="form-select form-select-sm" id="filterClassificacaoRisco">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Procedimento</label>
                            <div class="input-group dropdown">
                                <input type="text" class="form-control form-control-sm" 
                                       id="searchProcedimento" 
                                       placeholder="Digite para buscar procedimento..."
                                       autocomplete="off">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                                        type="button" 
                                        id="dropdownProcedimento" 
                                        data-bs-toggle="dropdown" 
                                        data-bs-auto-close="outside"
                                        aria-expanded="false">
                                    <i class="bi bi-list"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" 
                                        type="button" 
                                        onclick="limparFiltroProcedimento()"
                                        title="Limpar filtro de procedimento">
                                    <i class="bi bi-x"></i>
                                </button>
                                <ul class="dropdown-menu w-100" 
                                    id="dropdownListProcedimento" 
                                    style="max-height: 300px; overflow-y: auto; z-index: 1055;">
                                    <li><a class="dropdown-item" href="#" data-value="">Todos os procedimentos</a></li>
                                </ul>
                            </div>
                            <input type="hidden" id="filterProcedimento" value="">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Profissional</label>
                            <select class="form-select form-select-sm" id="filterProfissional">
                                <option value="">Todos</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label">Data Inicial</label>
                            <input type="date" class="form-control form-control-sm" id="filterDataInicial" 
                                   title="Filtrar solicitações a partir desta data">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data Final</label>
                            <input type="date" class="form-control form-control-sm" id="filterDataFinal" 
                                   title="Filtrar solicitações até esta data">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limparFiltrosData()">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Limpar Datas
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Ações em Lote -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button class="btn btn-outline-primary btn-sm me-2" onclick="selecionarTodos()">
                                        <i class="bi bi-check-square me-1"></i>
                                        Selecionar Todos
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="limparSelecao()">
                                        <i class="bi bi-square me-1"></i>
                                        Limpar Seleção
                                    </button>
                                </div>
                                <div>
                                    <span class="badge bg-info" id="contadorSelecionados">0 selecionados</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div class="text-center py-4 d-none" id="loadingSolicitacoes">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <small class="ms-2 text-muted">Carregando solicitações...</small>
                    </div>

                    <!-- Tabela de Solicitações -->
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="tabelaSolicitacoes">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" class="form-check-input" id="selectAllCheck">
                                    </th>
                                    <th width="80">ID Sol.</th>
                                    <th>Paciente</th>
                                    <th width="120">ID Paciente</th>
                                    <th>Procedimento</th>
                                    <th style="cursor: pointer; user-select: none;" onclick="ordenarPorDataHora()" title="Clique para ordenar por Data/Hora">
                                        Data/Hora
                                        <i id="iconeOrdenacao" class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                    </th>
                                    <!-- <th>Situação</th> -->
                                    <th>Classificação Risco</th>
                                    <th>Profissional</th>
                                    <th>Status Disparo</th>
                                    <th>Telefone</th>
                                    <th width="250">Observação</th>
                                    <th width="200">Agendamento</th>
                                    <th width="80">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="corpoTabelaSolicitacoes">
                                <!-- Dados serão inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="btnIniciarDisparo">
                        <i class="bi bi-send me-2"></i>
                        Iniciar Disparo (<span id="totalSelecionados">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Atualizar Lista -->
    <div class="modal fade" id="modalAtualizarLista" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>
                        Atualizar Lista - <span id="modalAtualizarListaNome"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Atenção:</strong> Você pode adicionar novos registros a esta lista fazendo upload de um novo PDF. 
                        Os registros serão integrados à lista existente, evitando duplicatas.
                    </div>
                    
                    <!-- Upload Area -->
                    <div class="upload-area text-center p-4 border border-2 border-dashed rounded" id="uploadAreaModal">
                        <i class="bi bi-cloud-upload display-4 text-muted mb-3"></i>
                        <h5 class="mb-2">Arraste seu PDF aqui</h5>
                        <p class="text-muted mb-3">ou clique para selecionar</p>
                        <button type="button" class="btn btn-outline-primary" id="selectFileModalBtn">
                            <i class="bi bi-file-plus me-2"></i>
                            Selecionar Arquivo PDF
                        </button>
                        <input type="file" id="fileInputModal" class="d-none" accept=".pdf">
                    </div>

                    <!-- File Info -->
                    <div class="d-none mt-3" id="fileInfoModal">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="bi bi-file-earmark-pdf me-2 text-danger"></i>
                                            <span id="fileNameModal">arquivo.pdf</span>
                                        </h6>
                                        <small class="text-muted" id="fileSizeModal">0 KB</small>
                                    </div>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFileModal()">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress -->
                    <div class="d-none mt-3" id="progressContainerModal">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Processando arquivo...</span>
                            <span id="progressTextModal">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBarModal" 
                                 style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="d-none mt-3" id="resultsModal">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Sucesso!</strong> <span id="resultsTextModal">Arquivo processado com sucesso!</span>
                        </div>
                    </div>

                    <!-- Error -->
                    <div class="d-none mt-3" id="errorModal">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Erro:</strong> <span id="errorTextModal">Ocorreu um erro no processamento.</span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success d-none" id="processModalBtn">
                        <i class="bi bi-gear me-2"></i>
                        Processar e Atualizar Lista
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript Customizado -->
    <script>
        // Estado da aplicação
        let allSources = [];
        let filteredSources = [];

        // Elementos DOM
        const loadingState = document.getElementById('loadingState');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const sourcesGrid = document.getElementById('sourcesGrid');
        const emptyState = document.getElementById('emptyState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const searchInput = document.getElementById('searchInput');

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se está em modo de edição
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            
            if (editId) {
                loadDisparoForEdit(editId);
            } else {
                loadSources();
            }
            
            setupEventListeners();
            
            // Event listener global para checkboxes individuais das solicitações
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('solicitacao-check')) {
                    const id = parseInt(e.target.value);
                    if (e.target.checked) {
                        selectedSolicitacoes.add(id);
                    } else {
                        selectedSolicitacoes.delete(id);
                    }
                    atualizarContadores();
                }
            });
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Busca
            searchInput.addEventListener('input', debounce(filterSources, 300));
            
            // Filtros de status
            document.querySelectorAll('input[name="statusFilter"]').forEach(input => {
                input.addEventListener('change', filterSources);
            });
        }

        // Carregar sources da API
        async function loadSources() {
            showState('loading');
            
            try {
                const response = await fetch('/api/sources');
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    allSources = data.data;
                    filteredSources = [...allSources];
                    
                    if (allSources.length === 0) {
                        showState('empty');
                    } else {
                        renderSources();
                        showState('sources');
                    }
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('Erro ao carregar sources:', error);
                errorMessage.textContent = error.message;
                showState('error');
            }
        }

        // Carregar disparo para edição
        async function loadDisparoForEdit(disparoId) {
            showState('loading');
            
            try {
                // Carregar dados do disparo
                const disparoResponse = await fetch(`/api/disparos/${disparoId}`);
                
                if (!disparoResponse.ok) {
                    throw new Error(`Erro ao carregar disparo: ${disparoResponse.status}`);
                }
                
                const disparoData = await disparoResponse.json();
                
                if (disparoData.status !== 'success') {
                    throw new Error(disparoData.message || 'Erro ao carregar disparo');
                }
                
                const disparo = disparoData.data;
                
                // Carregar sources
                const sourcesResponse = await fetch('/api/sources');
                
                if (!sourcesResponse.ok) {
                    throw new Error(`Erro ao carregar sources: ${sourcesResponse.status}`);
                }
                
                const sourcesData = await sourcesResponse.json();
                
                if (sourcesData.status !== 'success') {
                    throw new Error(sourcesData.message || 'Erro ao carregar sources');
                }
                
                allSources = sourcesData.data;
                filteredSources = [...allSources];
                
                // Renderizar sources
                if (allSources.length === 0) {
                    showState('empty');
                } else {
                    renderSources();
                    showState('sources');
                    
                    // Selecionar a source do disparo automaticamente
                    setTimeout(() => {
                        selectSource(disparo.source_id);
                        
                        // Preencher dados do disparo nos campos
                        document.querySelector('#modalConfiguracaoDisparo h5').textContent = 'Editar Disparo';
                        document.getElementById('tituloDisparo').value = disparo.titulo || '';
                        document.getElementById('descricaoDisparo').value = disparo.descricao || '';
                        
                        // Pré-selecionar solicitações que estão no disparo
                        const solicitacaoIds = disparo.solicitacoes.map(s => s.solicitacao_id);
                        solicitacaoIds.forEach(id => {
                            const checkbox = document.querySelector(`input[value="${id}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                        
                        // Atualizar contadores
                        updateSelectedCount();
                        
                        // Adicionar classe para identificar modo edição
                        document.body.dataset.editMode = disparoId;
                        
                        // Atualizar textos da interface para modo edição
                        document.title = 'Editar Disparo - Morrinhos';
                        document.querySelector('h2.mb-1').textContent = 'Editar Disparo';
                        document.querySelector('.card-header p').textContent = 'Modifique os dados do disparo e salve as alterações';
                        
                        // Atualizar botão
                        const btnIniciarDisparo = document.getElementById('btnIniciarDisparo');
                        if (btnIniciarDisparo) {
                            btnIniciarDisparo.innerHTML = '<i class="bi bi-save me-2"></i>Salvar Alterações (<span id="totalSelecionados">0</span>)';
                        }
                        
                        // Mostrar toast informativo
                        mostrarToast('Disparo carregado para edição. Modifique os dados e salve as alterações.', 'info');
                        
                    }, 500);
                }
                
            } catch (error) {
                console.error('Erro ao carregar disparo para edição:', error);
                errorMessage.textContent = error.message;
                showState('error');
            }
        }

        // Mostrar diferentes estados da interface
        function showState(state) {
            loadingState.classList.add('d-none');
            sourcesContainer.classList.add('d-none');
            emptyState.classList.add('d-none');
            errorState.classList.add('d-none');
            
            switch (state) {
                case 'loading':
                    loadingState.classList.remove('d-none');
                    break;
                case 'sources':
                    sourcesContainer.classList.remove('d-none');
                    break;
                case 'empty':
                    emptyState.classList.remove('d-none');
                    break;
                case 'error':
                    errorState.classList.remove('d-none');
                    break;
            }
        }

        // Renderizar sources na grade
        function renderSources() {
            sourcesGrid.innerHTML = '';
            
            if (filteredSources.length === 0) {
                sourcesGrid.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-4">
                            <i class="bi bi-search display-4 text-muted"></i>
                            <h5 class="mt-3">Nenhum resultado encontrado</h5>
                            <p class="text-muted">Tente ajustar os filtros de busca.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            filteredSources.forEach(source => {
                const sourceCard = createSourceCard(source);
                sourcesGrid.appendChild(sourceCard);
            });
        }

        // Criar card para uma source
        function createSourceCard(source) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-4';
            
            const statusClass = getStatusClass(source.status_processamento);
            const statusIcon = getStatusIcon(source.status_processamento);
            const dataUpload = new Date(source.data_upload).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            col.innerHTML = `
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-0 text-truncate" title="${source.nome}">${source.nome}</h6>
                            <span class="badge ${statusClass} ms-2">
                                <i class="${statusIcon} me-1"></i>
                                ${source.status_processamento}
                            </span>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Extraídos</small>
                                <strong class="h5 mb-0">${source.solicitacoes_extraidas}</strong>
                                <small class="text-muted">/ ${source.quantidade_itens}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Data Upload</small>
                                <small class="fw-bold">${dataUpload}</small>
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Disparos Enviados</small>
                                <span class="badge bg-primary">${source.solicitacoes_processadas}</span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Aguardando Disparo</small>
                                <span class="badge bg-warning">${source.solicitacoes_pendentes_disparo}</span>
                            </div>
                        </div>
                        
                        <!-- Progress Bars -->
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Extração</small>
                                <small class="fw-bold">${source.porcentagem_extracao}%</small>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar bg-info" 
                                     style="width: ${source.porcentagem_extracao}%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Disparos</small>
                                <small class="fw-bold">${source.porcentagem_disparo}%</small>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar ${getProgressBarClass(source.porcentagem_disparo)}" 
                                     style="width: ${source.porcentagem_disparo}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-white border-top-0">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="configurarDisparo(${source.id})">
                                <i class="bi bi-gear me-1"></i>
                                Configurar Disparo
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="atualizarLista(${source.id}, '${source.nome}')">
                                <i class="bi bi-plus-circle me-1"></i>
                                Atualizar Lista
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return col;
        }

        // Filtrar sources
        function filterSources() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusFilter = document.querySelector('input[name="statusFilter"]:checked').value;
            
            filteredSources = allSources.filter(source => {
                const matchesSearch = source.nome.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || source.status_processamento === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            renderSources();
        }

        // Funções utilitárias
        function getStatusClass(status) {
            switch (status) {
                case 'Disparos Concluídos': return 'bg-success';
                case 'Disparos em Andamento': return 'bg-warning';
                case 'Processando Disparos': return 'bg-info';
                case 'Pronto para Disparo': return 'bg-primary';
                case 'Aguardando Disparo': return 'bg-secondary';
                case 'Sem Dados Extraídos': return 'bg-danger';
                case 'Extração Incompleta': return 'bg-warning';
                case 'Concluído': return 'bg-success';
                default: return 'bg-secondary';
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'Disparos Concluídos': return 'bi bi-check-circle-fill';
                case 'Disparos em Andamento': return 'bi bi-clock-fill';
                case 'Processando Disparos': return 'bi bi-gear-fill';
                case 'Pronto para Disparo': return 'bi bi-play-circle-fill';
                case 'Aguardando Disparo': return 'bi bi-pause-circle-fill';
                case 'Sem Dados Extraídos': return 'bi bi-exclamation-triangle-fill';
                case 'Extração Incompleta': return 'bi bi-hourglass-split';
                case 'Concluído': return 'bi bi-check-circle-fill';
                default: return 'bi bi-question-circle-fill';
            }
        }

        function getProgressBarClass(percentage) {
            if (percentage === 100) return 'bg-success';
            if (percentage >= 50) return 'bg-warning';
            return 'bg-secondary';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Formatar data e hora para exibição
        function formatarDataHora(dataISO) {
            const date = new Date(dataISO);
            const dia = date.getDate().toString().padStart(2, '0');
            const mes = (date.getMonth() + 1).toString().padStart(2, '0');
            const ano = date.getFullYear();
            const horas = date.getHours().toString().padStart(2, '0');
            const minutos = date.getMinutes().toString().padStart(2, '0');
            
            // Formato: DD/MM/AAAA - HH:MM (ex: 14/08/2025 - 10:14)
            return `${dia}/${mes}/${ano} - ${horas}:${minutos}`;
        }

        // Mostrar toast de notificação
        function mostrarToast(mensagem, tipo = 'info') {
            // Remover toast anterior se existir
            const existingToast = document.getElementById('customToast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Criar toast
            const toast = document.createElement('div');
            toast.id = 'customToast';
            toast.className = `alert alert-${tipo} position-fixed`;
            toast.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease-out;
            `;
            
            const iconClass = tipo === 'success' ? 'bi-check-circle-fill' : 
                             tipo === 'danger' ? 'bi-exclamation-triangle-fill' : 
                             tipo === 'warning' ? 'bi-exclamation-triangle-fill' : 
                             'bi-info-circle-fill';
                             
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi ${iconClass} me-2"></i>
                    <span>${mensagem}</span>
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remover após 5 segundos
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        // Configurar disparo de uma source
        function configurarDisparo(sourceId) {
            const source = allSources.find(s => s.id === sourceId);
            if (!source) {
                alert('Source não encontrada!');
                return;
            }

            // Atualizar título do modal
            document.getElementById('modalSourceName').textContent = source.nome;
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('modalConfigurarDisparo'));
            modal.show();
            
            // Carregar solicitações da source
            carregarSolicitacoes(sourceId);
        }

        // Variáveis globais para o modal
        let currentSourceId = null;
        let allSolicitacoes = [];
        let filteredSolicitacoes = [];
        let selectedSolicitacoes = new Set();
        
        // Variáveis para controle da ordenação
        let ordenacaoAtual = 'desc'; // 'asc' ou 'desc' - começa com mais recente primeiro
        let colunaOrdenacao = 'data_hora';

        // Carregar solicitações de uma source
        async function carregarSolicitacoes(sourceId) {
            currentSourceId = sourceId;
            const loadingElement = document.getElementById('loadingSolicitacoes');
            const tableElement = document.getElementById('tabelaSolicitacoes');
            
            loadingElement.classList.remove('d-none');
            tableElement.classList.add('d-none');
            
            try {
                const response = await fetch(`/api/sources/${sourceId}/solicitacoes`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    allSolicitacoes = data.solicitacoes;
                    filteredSolicitacoes = [...allSolicitacoes];
                    
                    console.log('Solicitações carregadas:', allSolicitacoes.length);
                    
                    // Popular filtros
                    popularFiltros();
                    
                    // Aplicar ordenação inicial (mais recente primeiro)
                    aplicarOrdenacao();
                    
                    // Atualizar ícone de ordenação para mostrar estado inicial
                    const icone = document.getElementById('iconeOrdenacao');
                    if (icone) {
                        icone.className = 'bi bi-arrow-down ms-1 text-primary';
                        icone.title = 'Ordenado: mais recente primeiro';
                    }
                    
                    // Renderizar tabela
                    renderizarTabelaSolicitacoes();
                    
                    // Atualizar contadores
                    atualizarContadores();
                    
                    // Configurar event listeners do modal
                    setupModalEventListeners();
                    
                    // Inicializar dropdown de procedimentos
                    setTimeout(() => {
                        const dropdownBtn = document.getElementById('dropdownProcedimento');
                        if (dropdownBtn) {
                            console.log('Inicializando dropdown de procedimentos...');
                            
                            // Garantir que o dropdown funcione corretamente
                            dropdownBtn.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                console.log('Botão dropdown clicado!');
                                
                                const dropdownMenu = document.getElementById('dropdownListProcedimento');
                                if (dropdownMenu) {
                                    // Toggle manual da visibilidade
                                    if (dropdownMenu.classList.contains('show')) {
                                        dropdownMenu.classList.remove('show');
                                        this.setAttribute('aria-expanded', 'false');
                                    } else {
                                        dropdownMenu.classList.add('show');
                                        this.setAttribute('aria-expanded', 'true');
                                    }
                                }
                            });
                            
                            // Fechar dropdown ao clicar fora
                            document.addEventListener('click', function(e) {
                                const dropdownMenu = document.getElementById('dropdownListProcedimento');
                                const dropdown = document.querySelector('.dropdown');
                                
                                if (dropdownMenu && dropdown && !dropdown.contains(e.target)) {
                                    dropdownMenu.classList.remove('show');
                                    dropdownBtn.setAttribute('aria-expanded', 'false');
                                }
                            });
                        }
                    }, 500);
                    
                } else {
                    throw new Error(data.message || 'Erro ao carregar solicitações');
                }
                
            } catch (error) {
                console.error('Erro ao carregar solicitações:', error);
                alert('Erro ao carregar solicitações: ' + error.message);
            } finally {
                loadingElement.classList.add('d-none');
                tableElement.classList.remove('d-none');
            }
        }

        // Popular filtros com valores únicos
        function popularFiltros() {
            // const situacoes = [...new Set(allSolicitacoes.map(s => s.situacao).filter(Boolean))];
            const procedimentos = [...new Set(allSolicitacoes.map(s => s.procedimento).filter(Boolean))];
            const profissionais = [...new Set(allSolicitacoes.map(s => s.profissional_solicitante).filter(Boolean))];
            const classificacoesRisco = [...new Set(allSolicitacoes.map(s => s.classificacao_risco).filter(Boolean))];
            const statusDisparo = [...new Set(allSolicitacoes.map(s => s.status).filter(Boolean))];
            
            console.log('Classificações de risco disponíveis:', classificacoesRisco);
            console.log('Status de disparo disponíveis:', statusDisparo);
            
            //popularSelect('filterSituacao', situacoes);
            popularDropdownProcedimentos(procedimentos);
            popularSelect('filterProfissional', profissionais);
            popularSelect('filterClassificacaoRisco', classificacoesRisco);
            popularSelect('filterStatusDisparo', statusDisparo);
        }

        function popularSelect(selectId, opcoes) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Todos</option>';
            
            opcoes.forEach(opcao => {
                const option = document.createElement('option');
                option.value = opcao;
                option.textContent = opcao;
                select.appendChild(option);
            });
        }

        // Popular dropdown de procedimentos com busca
        function popularDropdownProcedimentos(procedimentos) {
            const dropdownList = document.getElementById('dropdownListProcedimento');
            const searchInput = document.getElementById('searchProcedimento');
            const hiddenInput = document.getElementById('filterProcedimento');
            
            console.log('Iniciando popularDropdownProcedimentos com', procedimentos.length, 'procedimentos');
            console.log('Elementos encontrados:', {
                dropdownList: !!dropdownList,
                searchInput: !!searchInput,
                hiddenInput: !!hiddenInput
            });
            
            if (!dropdownList || !searchInput || !hiddenInput) {
                console.error('Elementos do dropdown de procedimento não encontrados');
                return;
            }
            
            // Armazenar todos os procedimentos globalmente
            window.todosProcedimentos = procedimentos.sort();
            console.log('Procedimentos carregados:', procedimentos.length);
            
            // Popular lista inicial
            atualizarListaProcedimentos('');
            
            // Event listener para busca em tempo real
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                console.log('Input de busca:', searchTerm);
                atualizarListaProcedimentos(searchTerm);
                
                // Se o campo estiver vazio, limpar filtro
                if (searchTerm === '') {
                    hiddenInput.value = '';
                    filtrarSolicitacoes();
                }
            });
            
            // Event listener para seleção de item
            dropdownList.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Clique no dropdown list detectado:', e.target);
                
                if (e.target.classList.contains('dropdown-item')) {
                    const valor = e.target.dataset.value;
                    const texto = e.target.textContent;
                    
                    console.log('Item selecionado:', valor, texto);
                    
                    // Atualizar input visível e hidden
                    searchInput.value = valor === '' ? '' : texto;
                    hiddenInput.value = valor;
                    
                    // Fechar dropdown manualmente
                    const dropdownBtn = document.getElementById('dropdownProcedimento');
                    const dropdownMenu = document.getElementById('dropdownListProcedimento');
                    if (dropdownMenu) {
                        dropdownMenu.classList.remove('show');
                        if (dropdownBtn) {
                            dropdownBtn.setAttribute('aria-expanded', 'false');
                        }
                    }
                    
                    // Aplicar filtro
                    filtrarSolicitacoes();
                }
            });
            
            // Event listener para busca por Enter
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const searchTerm = this.value.toLowerCase().trim();
                    console.log('Enter pressionado com termo:', searchTerm);
                    
                    // Se há um termo de busca, usar como filtro direto
                    if (searchTerm) {
                        hiddenInput.value = '__search__:' + searchTerm;
                        filtrarSolicitacoes();
                        console.log('Busca por palavra-chave:', searchTerm);
                        
                        // Fechar dropdown manualmente
                        const dropdownBtn = document.getElementById('dropdownProcedimento');
                        const dropdownMenu = document.getElementById('dropdownListProcedimento');
                        if (dropdownMenu) {
                            dropdownMenu.classList.remove('show');
                            if (dropdownBtn) {
                                dropdownBtn.setAttribute('aria-expanded', 'false');
                            }
                        }
                    }
                }
            });
            
            console.log('Event listeners do dropdown configurados');
        }

        // Atualizar lista de procedimentos baseada na busca
        function atualizarListaProcedimentos(searchTerm) {
            const dropdownList = document.getElementById('dropdownListProcedimento');
            
            if (!dropdownList || !window.todosProcedimentos) {
                console.error('Dropdown list ou todosProcedimentos não encontrados');
                return;
            }
            
            // Filtrar procedimentos que contêm o termo de busca
            const procedimentosFiltrados = window.todosProcedimentos.filter(proc => 
                proc.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            // Reconstruir lista
            dropdownList.innerHTML = '<li><a class="dropdown-item" href="#" data-value="">Todos os procedimentos</a></li>';
            
            procedimentosFiltrados.forEach(procedimento => {
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item" href="#" data-value="${procedimento}">${procedimento}</a>`;
                dropdownList.appendChild(li);
            });
            
            // Se não há resultados, mostrar mensagem
            if (procedimentosFiltrados.length === 0 && searchTerm) {
                const li = document.createElement('li');
                li.innerHTML = '<span class="dropdown-item-text text-muted">Nenhum procedimento encontrado</span>';
                dropdownList.appendChild(li);
            }
        }

        // Renderizar tabela de solicitações
        function renderizarTabelaSolicitacoes() {
            const tbody = document.getElementById('corpoTabelaSolicitacoes');
            tbody.innerHTML = '';
            
            filteredSolicitacoes.forEach(solicitacao => {
                const row = criarLinhaSolicitacao(solicitacao);
                tbody.appendChild(row);
            });
            
            atualizarContadores();
        }

        // Criar linha da tabela para uma solicitação
        function criarLinhaSolicitacao(solicitacao) {
            const tr = document.createElement('tr');
            const isSelected = selectedSolicitacoes.has(solicitacao.id);
            
            // Extrair data de agendamento existente se houver
            let dataAgendamento = '';
            let temAgendamento = false;
            let infoAgendamento = '';
            
            if (solicitacao.schedule && solicitacao.schedule.data_agendamento) {
                const date = new Date(solicitacao.schedule.data_agendamento);
                dataAgendamento = date.toISOString().slice(0, 16); // Formato YYYY-MM-DDTHH:MM
                temAgendamento = true;
                
                // Informações detalhadas do agendamento
                const agendadoPor = solicitacao.schedule.agendado_por || 'Sistema';
                const dataFormatada = formatarDataHora(solicitacao.schedule.data_agendamento);
                
                infoAgendamento = `
                    <div class="text-success">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        <small><strong>Agendado para:</strong><br>
                        ${dataFormatada}<br>
                        <strong>Por:</strong> ${agendadoPor}</small>
                    </div>
                `;
            } else {
                infoAgendamento = `
                    <div class="text-muted">
                        <i class="bi bi-calendar-x me-1"></i>
                        <small>Sem agendamento</small>
                    </div>
                `;
            }
            
            tr.innerHTML = `
                <td>
                    <input type="checkbox" class="form-check-input solicitacao-check" 
                           value="${solicitacao.id}" ${isSelected ? 'checked' : ''}>
                </td>
                <td>
                    <small class="text-muted">#${solicitacao.solicitacao}</small>
                </td>
                <td>${solicitacao.paciente || '-'}</td>
                <td>
                    <small class="text-primary font-monospace">${solicitacao.identificacao_paciente || '-'}</small>
                </td>
                <td class="text-truncate" title="${solicitacao.procedimento || ''}" style="max-width: 200px;">
                    ${solicitacao.procedimento || '-'}
                </td>
                <td>${solicitacao.data_hora || '-'}</td>
                <!-- <td>
                <span class="badge bg-info">${solicitacao.situacao || '-'}</span>
                </td> -->
                <td>
                    <span class="badge ${getClassificacaoRiscoClass(solicitacao.classificacao_risco)}">
                        ${solicitacao.classificacao_risco || '-'}
                    </span>
                </td>
                <td>${solicitacao.profissional_solicitante || '-'}</td>
                <td>
                    <span class="badge ${getStatusDisparoClass(solicitacao.status)}">
                        ${getStatusDisparoLabel(solicitacao.status)}
                    </span>
                </td>
                <td>${solicitacao.celular_telefone || '-'}</td>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <textarea class="form-control form-control-sm observacao-input" 
                                  data-solicitacao-id="${solicitacao.id}" 
                                  rows="2" 
                                  style="min-width: 200px; resize: vertical;"
                                  placeholder="Adicionar observação..."
                                  title="Digite uma observação">${solicitacao.observacao || ''}</textarea>
                        <button class="btn btn-outline-primary btn-sm observacao-btn" 
                                onclick="salvarObservacao(${solicitacao.id})" 
                                title="Salvar observação">
                            <i class="bi bi-save"></i>
                        </button>
                    </div>
                </td>
                <td>
                    <input type="datetime-local" 
                           class="form-control form-control-sm agendamento-input ${temAgendamento ? 'border-success' : ''}" 
                           data-solicitacao-id="${solicitacao.id}" 
                           value="${dataAgendamento}"
                           title="Selecione data e hora do agendamento">
                    <div class="mt-1 status-agendamento">
                        ${infoAgendamento}
                    </div>
                </td>
                <td>
                    <button class="btn btn-success btn-sm agendamento-btn" onclick="salvarAgendamento(${solicitacao.id})" 
                            title="Salvar agendamento">
                        <i class="bi bi-check"></i>
                    </button>
                </td>
            `;
            
            return tr;
        }

        // Funções auxiliares para status de disparo
        function getStatusDisparoClass(status) {
            switch (status) {
                case 'pendente': return 'bg-secondary';
                case 'em_fila': return 'bg-warning';
                case 'enviado': return 'bg-primary';
                case 'respondido': return 'bg-info';
                case 'agendado': return 'bg-success';
                case 'rejeitado': return 'bg-danger';
                case 'sem_resposta': return 'bg-warning';
                case 'cancelado': return 'bg-dark';
                case 'erro': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function getStatusDisparoLabel(status) {
            switch (status) {
                case 'pendente': return 'Pendente';
                case 'em_fila': return 'Em Fila';
                case 'enviado': return 'Enviado';
                case 'respondido': return 'Respondido';
                case 'agendado': return 'Agendado';
                case 'rejeitado': return 'Rejeitado';
                case 'sem_resposta': return 'Sem Resposta';
                case 'cancelado': return 'Cancelado';
                case 'erro': return 'Erro';
                default: return 'Desconhecido';
            }
        }

        // Função auxiliar para classificação de risco
        function getClassificacaoRiscoClass(classificacao) {
            if (!classificacao || classificacao === '-') return 'bg-secondary';
            
            const classificacaoUpper = classificacao.toUpperCase().trim();
            
            // Sistema de cores baseado na urgência (do mais urgente para o menos urgente)
            
            // Vermelho - EMERGÊNCIA (mais crítico)
            if (classificacaoUpper === 'EMERGÊNCIA' || classificacaoUpper === 'EMERGENCIA') {
                return 'bg-danger';
            }
            
            // Laranja escuro - MUITO URGENTE (segundo mais crítico)
            if (classificacaoUpper === 'MUITO URGENTE') {
                return 'bg-warning text-dark';
            }
            
            // Amarelo - URGENTE (terceiro nível de urgência)
            if (classificacaoUpper === 'URGENTE') {
                return 'bg-warning';
            }
            
            // Azul claro - POUCO URGENTE (quarto nível)
            if (classificacaoUpper === 'POUCO URGENTE') {
                return 'bg-info';
            }
            
            // Verde - NÃO URGENTE (menos crítico)
            if (classificacaoUpper === 'NAO URGENTE' || classificacaoUpper === 'NÃO URGENTE') {
                return 'bg-success';
            }
            
            // Padrão para classificações não reconhecidas
            return 'bg-secondary';
        }

        // Configurar event listeners do modal
        function setupModalEventListeners() {
            // Remover event listeners anteriores para evitar duplicação
            const elements = [
                'searchSolicitacoes',
                //'filterSituacao',
                'filterProfissional',
                'filterClassificacaoRisco',
                'filterStatusDisparo',
                'filterDataInicial',
                'filterDataFinal'
            ];
            
            elements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    // Clonar o elemento para remover todos os event listeners
                    const newElement = element.cloneNode(true);
                    element.parentNode.replaceChild(newElement, element);
                }
            });
            
            // Busca
            document.getElementById('searchSolicitacoes').addEventListener('input', debounce(filtrarSolicitacoes, 300));
            
            // Filtros
            //document.getElementById('filterSituacao').addEventListener('change', filtrarSolicitacoes);
            // filterProcedimento é gerenciado pela função popularDropdownProcedimentos()
            document.getElementById('filterProfissional').addEventListener('change', filtrarSolicitacoes);
            document.getElementById('filterClassificacaoRisco').addEventListener('change', filtrarSolicitacoes);
            document.getElementById('filterStatusDisparo').addEventListener('change', filtrarSolicitacoes);
            
            // Filtros de data
            document.getElementById('filterDataInicial').addEventListener('change', filtrarSolicitacoes);
            document.getElementById('filterDataFinal').addEventListener('change', filtrarSolicitacoes);
            
            // Select all
            const selectAllCheck = document.getElementById('selectAllCheck');
            if (selectAllCheck) {
                const newSelectAll = selectAllCheck.cloneNode(true);
                selectAllCheck.parentNode.replaceChild(newSelectAll, selectAllCheck);
                
                newSelectAll.addEventListener('change', function() {
                    const isChecked = this.checked;
                    document.querySelectorAll('.solicitacao-check').forEach(check => {
                        check.checked = isChecked;
                        if (isChecked) {
                            selectedSolicitacoes.add(parseInt(check.value));
                        } else {
                            selectedSolicitacoes.delete(parseInt(check.value));
                        }
                    });
                    atualizarContadores();
                });
            }
            
            console.log('Event listeners configurados para filtros');
        }

        // Função para extrair data de uma string de data/hora
        function extrairDataSolicitacao(dataHoraStr) {
            if (!dataHoraStr || dataHoraStr === '-') return null;
            
            try {
                // Tentar diferentes formatos de data comuns
                let dataObj = null;
                
                // Formato brasileiro: dd/mm/yyyy ou dd/mm/yyyy hh:mm
                const formatoBR = /(\d{1,2})\/(\d{1,2})\/(\d{4})/;
                const matchBR = dataHoraStr.match(formatoBR);
                if (matchBR) {
                    const [, dia, mes, ano] = matchBR;
                    dataObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                }
                
                // Formato ISO: yyyy-mm-dd ou yyyy-mm-dd hh:mm:ss
                const formatoISO = /(\d{4})-(\d{1,2})-(\d{1,2})/;
                const matchISO = dataHoraStr.match(formatoISO);
                if (!dataObj && matchISO) {
                    const [, ano, mes, dia] = matchISO;
                    dataObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                }
                
                // Tentar parsing direto como último recurso
                if (!dataObj) {
                    dataObj = new Date(dataHoraStr);
                }
                
                // Verificar se a data é válida
                if (dataObj && !isNaN(dataObj.getTime())) {
                    return dataObj;
                }
                
                return null;
            } catch (error) {
                console.warn('Erro ao extrair data:', dataHoraStr, error);
                return null;
            }
        }

        // Filtrar solicitações
        function filtrarSolicitacoes() {
            const searchTerm = document.getElementById('searchSolicitacoes').value.toLowerCase();
            //const situacao = document.getElementById('filterSituacao').value;
            const procedimento = document.getElementById('filterProcedimento').value;
            const profissional = document.getElementById('filterProfissional').value;
            const classificacaoRisco = document.getElementById('filterClassificacaoRisco').value;
            const statusDisparo = document.getElementById('filterStatusDisparo').value;
            const dataInicial = document.getElementById('filterDataInicial').value;
            const dataFinal = document.getElementById('filterDataFinal').value;
            
            console.log('Aplicando filtros:', {
                searchTerm,
                //situacao,
                procedimento,
                profissional,
                classificacaoRisco,
                statusDisparo,
                dataInicial,
                dataFinal
            });
            
            filteredSolicitacoes = allSolicitacoes.filter(sol => {
                const matchesSearch = (sol.paciente || '').toLowerCase().includes(searchTerm);
                //const matchesSituacao = !situacao || sol.situacao === situacao;
                
                // Filtro de procedimento - suportar busca por palavra-chave
                let matchesProcedimento = true;
                if (procedimento) {
                    if (procedimento.startsWith('__search__:')) {
                        // Busca por palavra-chave
                        const searchKeyword = procedimento.replace('__search__:', '').toLowerCase();
                        matchesProcedimento = (sol.procedimento || '').toLowerCase().includes(searchKeyword);
                        console.log('Filtro procedimento busca:', searchKeyword, 'em', sol.procedimento, '=', matchesProcedimento);
                    } else {
                        // Filtro exato
                        matchesProcedimento = sol.procedimento === procedimento;
                        console.log('Filtro procedimento exato:', procedimento, '=', sol.procedimento, '=', matchesProcedimento);
                    }
                }
                
                const matchesProfissional = !profissional || sol.profissional_solicitante === profissional;
                
                // Debug para classificação de risco
                const matchesClassificacaoRisco = !classificacaoRisco || (sol.classificacao_risco && sol.classificacao_risco.toString().trim() === classificacaoRisco.toString().trim());
                
                // Filtro de status de disparo
                const matchesStatusDisparo = !statusDisparo || sol.status === statusDisparo;
                
                // Debug detalhado para casos que não passam no filtro
                if (classificacaoRisco && !matchesClassificacaoRisco) {
                    console.log('Filtro classificação risco não matched:', {
                        solicitacao: sol.solicitacao,
                        classificacao_db: sol.classificacao_risco,
                        filtro_selecionado: classificacaoRisco,
                        match: matchesClassificacaoRisco
                    });
                }
                
                // Filtro por data
                let matchesData = true;
                if (dataInicial || dataFinal) {
                    const dataSolicitacao = extrairDataSolicitacao(sol.data_hora);
                    if (dataSolicitacao) {
                        if (dataInicial) {
                            const dataInicialObj = new Date(dataInicial);
                            matchesData = matchesData && dataSolicitacao >= dataInicialObj;
                        }
                        if (dataFinal) {
                            const dataFinalObj = new Date(dataFinal);
                            dataFinalObj.setHours(23, 59, 59, 999); // Incluir todo o dia final
                            matchesData = matchesData && dataSolicitacao <= dataFinalObj;
                        }
                    } else {
                        // Se não conseguir extrair a data, não incluir no filtro se houver filtro de data
                        matchesData = false;
                    }
                }
                
                const result = matchesSearch && matchesProcedimento && matchesProfissional && matchesClassificacaoRisco && matchesStatusDisparo && matchesData;
                
                // Debug para primeira solicitação
                if (sol === allSolicitacoes[0]) {
                    console.log('Debug primeira solicitação:', {
                        paciente: sol.paciente,
                        matchesSearch,
                        //matchesSituacao,
                        matchesProcedimento,
                        matchesProfissional,
                        matchesClassificacaoRisco,
                        matchesStatusDisparo,
                        matchesData,
                        result
                    });
                }
                
                return result;
            });
            
            console.log(`Filtros aplicados: ${allSolicitacoes.length} -> ${filteredSolicitacoes.length} solicitações`);
            
            // Aplicar ordenação após filtrar
            aplicarOrdenacao();
            
            renderizarTabelaSolicitacoes();
            atualizarContadores();
        }

        // Função para ordenar por Data/Hora
        function ordenarPorDataHora() {
            // Alternar entre ascendente e descendente
            ordenacaoAtual = ordenacaoAtual === 'asc' ? 'desc' : 'asc';
            
            // Atualizar ícone
            const icone = document.getElementById('iconeOrdenacao');
            if (icone) {
                if (ordenacaoAtual === 'asc') {
                    icone.className = 'bi bi-arrow-up ms-1 text-primary';
                    icone.title = 'Ordenado: mais antigo primeiro';
                } else {
                    icone.className = 'bi bi-arrow-down ms-1 text-primary';
                    icone.title = 'Ordenado: mais recente primeiro';
                }
            }
            
            // Aplicar ordenação
            aplicarOrdenacao();
            
            // Re-renderizar tabela
            renderizarTabelaSolicitacoes();
            
            console.log(`Ordenação aplicada: ${ordenacaoAtual} por ${colunaOrdenacao}`);
        }
        
        // Função para aplicar ordenação nas solicitações filtradas
        function aplicarOrdenacao() {
            if (colunaOrdenacao === 'data_hora') {
                filteredSolicitacoes.sort((a, b) => {
                    const dataA = extrairDataSolicitacao(a.data_hora);
                    const dataB = extrairDataSolicitacao(b.data_hora);
                    
                    // Tratar casos onde não conseguimos extrair a data
                    if (!dataA && !dataB) return 0;
                    if (!dataA) return 1; // Colocar itens sem data no final
                    if (!dataB) return -1;
                    
                    // Comparar datas
                    if (ordenacaoAtual === 'asc') {
                        return dataA.getTime() - dataB.getTime(); // Mais antigo primeiro
                    } else {
                        return dataB.getTime() - dataA.getTime(); // Mais recente primeiro
                    }
                });
            }
        }

        // Funções de seleção
        function selecionarTodos() {
            filteredSolicitacoes.forEach(sol => selectedSolicitacoes.add(sol.id));
            document.querySelectorAll('.solicitacao-check').forEach(check => check.checked = true);
            document.getElementById('selectAllCheck').checked = true;
            atualizarContadores();
        }

        function limparSelecao() {
            selectedSolicitacoes.clear();
            document.querySelectorAll('.solicitacao-check').forEach(check => check.checked = false);
            document.getElementById('selectAllCheck').checked = false;
            atualizarContadores();
        }

        // Limpar filtros de data
        function limparFiltrosData() {
            console.log('Limpando filtros de data');
            document.getElementById('filterDataInicial').value = '';
            document.getElementById('filterDataFinal').value = '';
            // Aplicar filtros sem os filtros de data
            filtrarSolicitacoes();
        }

        // Limpar filtro de procedimento
        function limparFiltroProcedimento() {
            console.log('Limpando filtro de procedimento');
            const searchInput = document.getElementById('searchProcedimento');
            const hiddenInput = document.getElementById('filterProcedimento');
            
            if (searchInput) {
                searchInput.value = '';
            }
            if (hiddenInput) {
                hiddenInput.value = '';
            }
            
            // Aplicar filtros sem o filtro de procedimento
            filtrarSolicitacoes();
        }

        // Atualizar contadores
        function atualizarContadores() {
            const count = selectedSolicitacoes.size;
            const totalItens = allSolicitacoes.length;
            const totalFiltrados = filteredSolicitacoes.length;
            
            // Verificar se os elementos existem antes de atualizar
            const contadorSelecionados = document.getElementById('contadorSelecionados');
            if (contadorSelecionados) {
                contadorSelecionados.textContent = `${count} selecionados`;
            }
            
            const totalSelecionados = document.getElementById('totalSelecionados');
            if (totalSelecionados) {
                totalSelecionados.textContent = count;
            }
            
            const btnIniciarDisparo = document.getElementById('btnIniciarDisparo');
            if (btnIniciarDisparo) {
                btnIniciarDisparo.disabled = count === 0;
            }
            
            // Atualizar badges no cabeçalho
            const totalItensSource = document.getElementById('totalItensSource');
            if (totalItensSource) {
                totalItensSource.textContent = `${totalItens} itens`;
            }
            
            const totalFiltradosEl = document.getElementById('totalFiltrados');
            if (totalFiltradosEl) {
                totalFiltradosEl.textContent = `${totalFiltrados} filtrados`;
            }
            
            const totalSelecionadosHeader = document.getElementById('totalSelecionadosHeader');
            if (totalSelecionadosHeader) {
                totalSelecionadosHeader.textContent = `${count} selecionados`;
            }
            
            // Atualizar badge de filtro de data
            const filtroDataAtivo = document.getElementById('filtroDataAtivo');
            const dataInicial = document.getElementById('filterDataInicial')?.value;
            const dataFinal = document.getElementById('filterDataFinal')?.value;
            
            if (filtroDataAtivo) {
                if (dataInicial || dataFinal) {
                    filtroDataAtivo.classList.remove('d-none');
                    let textoFiltro = 'Filtro Data';
                    if (dataInicial && dataFinal) {
                        const dataIni = new Date(dataInicial).toLocaleDateString('pt-BR');
                        const dataFim = new Date(dataFinal).toLocaleDateString('pt-BR');
                        textoFiltro = `${dataIni} - ${dataFim}`;
                    } else if (dataInicial) {
                        const dataIni = new Date(dataInicial).toLocaleDateString('pt-BR');
                        textoFiltro = `A partir de ${dataIni}`;
                    } else if (dataFinal) {
                        const dataFim = new Date(dataFinal).toLocaleDateString('pt-BR');
                        textoFiltro = `Até ${dataFim}`;
                    }
                    filtroDataAtivo.innerHTML = `<i class="bi bi-calendar-range me-1"></i>${textoFiltro}`;
                } else {
                    filtroDataAtivo.classList.add('d-none');
                }
            }
        }

        // Iniciar disparo
        document.getElementById('btnIniciarDisparo').addEventListener('click', async function() {
            if (selectedSolicitacoes.size === 0) {
                alert('Selecione pelo menos uma solicitação para iniciar o disparo.');
                return;
            }

            // Verificar se está em modo edição
            const editMode = document.body.dataset.editMode;
            const isEdit = !!editMode;

            // Criar modal de confirmação com input para nome
            const disparoData = await mostrarModalConfirmacaoDisparo();
            if (!disparoData) return;

            try {
                // Desabilitar botão durante o processo
                this.disabled = true;
                this.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${isEdit ? 'Salvando...' : 'Criando...'}`;

                // Obter configuração dos filtros aplicados
                const configuracao = {
                    filtros: {
                        busca: document.getElementById('searchSolicitacoes').value,
                        //situacao: document.getElementById('filterSituacao').value,
                        procedimento: document.getElementById('filterProcedimento').value,
                        profissional: document.getElementById('filterProfissional').value,
                        classificacaoRisco: document.getElementById('filterClassificacaoRisco').value,
                        statusDisparo: document.getElementById('filterStatusDisparo').value
                    },
                    timestamp: new Date().toISOString()
                };

                const requestData = {
                    nome: disparoData.nome,
                    descricao: disparoData.descricao,
                    source_id: currentSourceId,
                    solicitacoes_ids: Array.from(selectedSolicitacoes),
                    profissional: document.getElementById('filterProfissional').value, // Incluindo o profissional nas variáveis
                    configuracao: configuracao
                };

                // Configurar URL e método baseado no modo
                const url = isEdit ? `/api/disparos/${editMode}` : '/api/disparos';
                const method = isEdit ? 'PUT' : 'POST';

                // Criar/Atualizar disparo via API
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (response.ok) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfigurarDisparo'));
                    if (modal) {
                        modal.hide();
                    }

                    // Mostrar sucesso
                    const action = isEdit ? 'atualizado' : 'criado';
                    alert(`✅ Disparo "${disparoData.nome}" ${action} com sucesso!\nID: ${result.data.id}\nSolicitações: ${selectedSolicitacoes.size}`);

                    // Se for edição, redirecionar para a lista de disparos
                    if (isEdit) {
                        window.location.href = '/disparos';
                    } else {
                        // Limpar seleção apenas se for criação nova
                        selectedSolicitacoes.clear();
                        atualizarContadores();
                    }

                } else {
                    throw new Error(result.message || `Erro ao ${isEdit ? 'atualizar' : 'criar'} disparo`);
                }

            } catch (error) {
                console.error(`Erro ao ${isEdit ? 'atualizar' : 'criar'} disparo:`, error);
                alert(`❌ Erro ao ${isEdit ? 'atualizar' : 'criar'} disparo: ` + error.message);
            } finally {
                // Reabilitar botão
                this.disabled = false;
                const action = document.body.dataset.editMode ? 'Salvar' : 'Iniciar';
                this.innerHTML = `<i class="bi bi-${document.body.dataset.editMode ? 'save' : 'send'} me-2"></i>${action} Disparo (<span id="totalSelecionados">0</span>)`;
                
                // Aguardar um momento para o DOM ser atualizado e verificar se elementos existem
                setTimeout(() => {
                    const totalSelecionados = document.getElementById('totalSelecionados');
                    if (totalSelecionados) {
                        atualizarContadores(); // Para atualizar o contador no botão
                    } else {
                        console.warn('Elemento totalSelecionados não encontrado, aguardando mais tempo...');
                        setTimeout(atualizarContadores, 200);
                    }
                }, 100);
            }
        });

        // Salvar agendamento individual
        async function salvarAgendamento(solicitacaoId) {
            const input = document.querySelector(`input[data-solicitacao-id="${solicitacaoId}"]`);
            const dataAgendamento = input.value;
            
            if (!dataAgendamento) {
                alert('Por favor, selecione uma data e hora para o agendamento.');
                return;
            }
            
            // Validar se a data não é no passado
            const agendamentoDate = new Date(dataAgendamento);
            const agora = new Date();
            if (agendamentoDate < agora) {
                alert('A data do agendamento não pode ser no passado.');
                return;
            }
            
            try {
                // Desabilitar botão durante o salvamento
                const btn = event.target.closest('button');
                const row = btn.closest('tr');
                const statusCell = row.querySelector('.status-agendamento');
                const originalContent = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
                
                // Montar objeto de agendamento
                const scheduleData = {
                    data_agendamento: dataAgendamento,
                    agendado_por: 'Sistema - Interface Web',
                    observacoes: `Agendamento definido em ${new Date().toLocaleString('pt-BR')} via interface web`
                };
                
                const response = await fetch(`/api/solicitacoes/${solicitacaoId}/schedule`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        schedule: scheduleData
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Atualizar dados locais
                    const solicitacao = allSolicitacoes.find(s => s.id === solicitacaoId);
                    if (solicitacao) {
                        solicitacao.schedule = scheduleData;
                    }
                    
                    // Feedback visual de sucesso
                    btn.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                    input.classList.add('border-success');
                    
                    // Atualizar status visual
                    if (statusCell) {
                        statusCell.innerHTML = `
                            <div class="text-success">
                                <i class="bi bi-check-circle-fill me-1"></i>
                                <small><strong>Agendado para:</strong><br>
                                ${formatarDataHora(dataAgendamento)}<br>
                                <strong>Por:</strong> ${scheduleData.agendado_por}</small>
                            </div>
                        `;
                    }
                    
                    // Mostrar toast de sucesso
                    mostrarToast('Agendamento salvo com sucesso!', 'success');
                    
                    // Restaurar botão após 3 segundos
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }, 3000);
                    
                } else {
                    throw new Error(result.message || 'Erro ao salvar agendamento');
                }
                
            } catch (error) {
                console.error('Erro ao salvar agendamento:', error);
                mostrarToast('Erro ao salvar agendamento: ' + error.message, 'danger');
                
                // Restaurar botão em caso de erro
                const btn = event.target.closest('button');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-danger"></i>';
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="bi bi-check"></i>';
                }, 3000);
            }
        }

        // Salvar observação individual
        async function salvarObservacao(solicitacaoId) {
            const textarea = document.querySelector(`textarea[data-solicitacao-id="${solicitacaoId}"]`);
            const observacao = textarea.value.trim();
            
            try {
                // Desabilitar botão e textarea durante o salvamento
                const btn = event.target.closest('button');
                const originalBtnContent = btn.innerHTML;
                
                btn.disabled = true;
                textarea.disabled = true;
                btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
                
                const response = await fetch(`/api/solicitacoes/${solicitacaoId}/observacao`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        observacao: observacao
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Atualizar dados locais
                    const solicitacao = allSolicitacoes.find(s => s.id === solicitacaoId);
                    if (solicitacao) {
                        solicitacao.observacao = observacao;
                    }
                    
                    // Feedback visual de sucesso
                    btn.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                    textarea.classList.add('border-success');
                    
                    // Mostrar toast de sucesso
                    mostrarToast('Observação salva com sucesso!', 'success');
                    
                    // Restaurar botão após 2 segundos
                    setTimeout(() => {
                        btn.disabled = false;
                        textarea.disabled = false;
                        btn.innerHTML = originalBtnContent;
                        textarea.classList.remove('border-success');
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || 'Erro ao salvar observação');
                }
                
            } catch (error) {
                console.error('Erro ao salvar observação:', error);
                mostrarToast('Erro ao salvar observação: ' + error.message, 'danger');
                
                // Restaurar controles em caso de erro
                const btn = event.target.closest('button');
                const textarea = document.querySelector(`textarea[data-solicitacao-id="${solicitacaoId}"]`);
                
                btn.disabled = false;
                textarea.disabled = false;
                btn.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-danger"></i>';
                textarea.classList.add('border-danger');
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="bi bi-save"></i>';
                    textarea.classList.remove('border-danger');
                }, 3000);
            }
        }

        // Função para mostrar modal de confirmação
        function mostrarModalConfirmacaoDisparo() {
            return new Promise((resolve) => {
                const nome = prompt('Digite um nome para este disparo:');
                if (!nome || nome.trim() === '') {
                    resolve(null);
                    return;
                }

                const descricao = prompt('Digite uma descrição (opcional):') || '';
                
                const confirmar = confirm(`Confirma a criação do disparo "${nome}" com ${selectedSolicitacoes.size} solicitações?`);
                
                if (confirmar) {
                    resolve({
                        nome: nome.trim(),
                        descricao: descricao.trim()
                    });
                } else {
                    resolve(null);
                }
            });
        }

        // ============ FUNCIONALIDADE ATUALIZAR LISTA ============

        let updateSourceId = null;
        let selectedFileModal = null;

        // Abrir modal para atualizar lista
        function atualizarLista(sourceId, sourceName) {
            updateSourceId = sourceId;
            document.getElementById('modalAtualizarListaNome').textContent = sourceName;
            
            // Reset modal state
            resetModalState();
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalAtualizarLista'));
            modal.show();
            
            // Setup event listeners para o modal de upload
            setupUploadModalEventListeners();
        }

        // Reset estado do modal
        function resetModalState() {
            selectedFileModal = null;
            document.getElementById('fileInputModal').value = '';
            document.getElementById('fileInfoModal').classList.add('d-none');
            document.getElementById('progressContainerModal').classList.add('d-none');
            document.getElementById('resultsModal').classList.add('d-none');
            document.getElementById('errorModal').classList.add('d-none');
            document.getElementById('processModalBtn').classList.add('d-none');
            document.getElementById('uploadAreaModal').style.display = 'block';
        }

        // Setup event listeners do modal de upload
        function setupUploadModalEventListeners() {
            const selectFileBtn = document.getElementById('selectFileModalBtn');
            const fileInput = document.getElementById('fileInputModal');
            const processBtn = document.getElementById('processModalBtn');
            const uploadArea = document.getElementById('uploadAreaModal');

            // Clique no botão de selecionar arquivo
            selectFileBtn.onclick = () => fileInput.click();

            // Mudança de arquivo
            fileInput.onchange = (e) => handleFileSelectionModal(e.target.files[0]);

            // Drag and drop
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-primary');
            };

            uploadArea.ondragleave = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-primary');
            };

            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-primary');
                const file = e.dataTransfer.files[0];
                if (file) handleFileSelectionModal(file);
            };

            // Processar arquivo
            processBtn.onclick = () => processFileModal();
        }

        // Tratar seleção de arquivo no modal
        function handleFileSelectionModal(file) {
            if (!file) return;

            // Validar tipo de arquivo
            if (file.type !== 'application/pdf') {
                mostrarToast('Erro: Apenas arquivos PDF são aceitos', 'danger');
                return;
            }

            // Validar tamanho (50MB)
            if (file.size > 50 * 1024 * 1024) {
                mostrarToast('Erro: Arquivo muito grande. Limite de 50MB', 'danger');
                return;
            }

            selectedFileModal = file;

            // Mostrar informações do arquivo
            document.getElementById('fileNameModal').textContent = file.name;
            document.getElementById('fileSizeModal').textContent = formatFileSize(file.size);
            document.getElementById('fileInfoModal').classList.remove('d-none');
            document.getElementById('processModalBtn').classList.remove('d-none');
            document.getElementById('uploadAreaModal').style.display = 'none';
        }

        // Remover arquivo selecionado
        function removeFileModal() {
            selectedFileModal = null;
            document.getElementById('fileInputModal').value = '';
            document.getElementById('fileInfoModal').classList.add('d-none');
            document.getElementById('processModalBtn').classList.add('d-none');
            document.getElementById('uploadAreaModal').style.display = 'block';
        }

        // Processar arquivo e atualizar lista
        async function processFileModal() {
            if (!selectedFileModal || !updateSourceId) return;

            const progressContainer = document.getElementById('progressContainerModal');
            const progressBar = document.getElementById('progressBarModal');
            const progressText = document.getElementById('progressTextModal');
            const processBtn = document.getElementById('processModalBtn');

            try {
                // Mostrar progresso
                progressContainer.classList.remove('d-none');
                processBtn.disabled = true;

                // Preparar FormData
                const formData = new FormData();
                formData.append('file', selectedFileModal); // Nome correto do campo
                formData.append('sourceId', updateSourceId); // Informar que é uma atualização

                // Simular progresso durante upload
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                }, 500);

                // Fazer upload
                const response = await fetch('http://localhost:5000/upload', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = '100%';

                if (response.ok) {
                    const result = await response.json();
                    
                    // Mostrar sucesso
                    document.getElementById('resultsTextModal').textContent = 
                        `${result.registros_inseridos || 0} novos registros adicionados à lista!`;
                    document.getElementById('resultsModal').classList.remove('d-none');
                    
                    // Verificar se há avisos sobre duplicatas ou registros inválidos
                    if (result.warnings && result.warnings.length > 0) {
                        let warningMessages = [];
                        
                        result.warnings.forEach(warning => {
                            if (warning.type === 'duplicates') {
                                warningMessages.push(`⚠️ ${warning.message}:`);
                                warning.details.forEach(dup => {
                                    warningMessages.push(`• Solicitação ${dup.solicitacao} - ${dup.paciente} (${dup.procedimento})`);
                                });
                            } else if (warning.type === 'invalid') {
                                warningMessages.push(`⚠️ ${warning.message}:`);
                                warning.details.forEach(inv => {
                                    warningMessages.push(`• ${inv.paciente} - ${inv.motivo}`);
                                });
                            }
                        });
                        
                        if (warningMessages.length > 0) {
                            // Mostrar warnings em um alert detalhado
                            const warningText = warningMessages.join('\n');
                            setTimeout(() => {
                                alert(`Lista atualizada com avisos:\n\n${warningText}`);
                            }, 500);
                            
                            // Também mostrar um toast mais amigável
                            let toastMessage = `Lista atualizada! ${result.registros_inseridos} novos registros`;
                            if (result.warnings.find(w => w.type === 'duplicates')) {
                                const dupCount = result.warnings.find(w => w.type === 'duplicates').count;
                                toastMessage += ` (${dupCount} duplicados ignorados)`;
                            }
                            mostrarToast(toastMessage, 'warning');
                        } else {
                            mostrarToast('Lista atualizada com sucesso!', 'success');
                        }
                    } else {
                        mostrarToast('Lista atualizada com sucesso!', 'success');
                    }

                    // Recarregar sources após 2 segundos
                    setTimeout(() => {
                        loadSources();
                        bootstrap.Modal.getInstance(document.getElementById('modalAtualizarLista')).hide();
                    }, 2000);

                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro no processamento');
                }

            } catch (error) {
                console.error('Erro ao processar arquivo:', error);
                document.getElementById('errorTextModal').textContent = error.message;
                document.getElementById('errorModal').classList.remove('d-none');
                mostrarToast('Erro ao atualizar lista: ' + error.message, 'danger');
            } finally {
                processBtn.disabled = false;
            }
        }

        // Formatar tamanho do arquivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
