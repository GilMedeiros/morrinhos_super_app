<!DOCTYPE html>
<html lang="pt-BR">
<!-- <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparo - Sistema PDF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/styles-simple.css" rel="stylesheet">
</head> -->
<%- include('partials/header') %>
<style>
    /* Estilo para colunas de ordenação */
    th[onclick] {
        transition: background-color 0.2s ease;
    }
    
    th[onclick]:hover {
        background-color: rgba(0, 123, 255, 0.1) !important;
    }
    
    /* Estilo para ícones de ordenação */
    #iconeOrdenacao {
        font-size: 0.8em;
        transition: color 0.2s ease;
    }
    
    /* Indicador visual de que a coluna é clicável */
    th[onclick]::after {
        content: "";
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        opacity: 0.3;
    }
</style>
<body>
    <!-- Navigation -->
    <!-- <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-file-earmark-pdf me-2"></i>Sistema PDF</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/"><i class="bi bi-send me-1"></i>Criar Disparo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/upload"><i class="bi bi-plus-circle me-1"></i>Nova Lista</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/disparos"><i class="bi bi-list-check me-1"></i>Gerenciar Disparos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/configuracoes"><i class="bi bi-gear me-1"></i>Configurações</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav> -->
<%- include('partials/nav') %>
    <!-- Main Content -->
    <div class="container-fluid mt-3">
        <!-- Header Section -->
        <div class="text-center mb-4">
            <div class="d-flex justify-content-center gap-3 align-items-center mb-3">
                <img src="img/conecta.png" alt="Logo Conecta" style="height: 40px;">
                <img src="img/morrinhos.png" alt="Logo Morrinhos" style="height: 40px;">
            </div>
        </div>

        <!-- Page Header -->
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card main-card mb-4">
                    <div class="card-header text-center">
                        <h2 class="mb-1">
                            <i class="bi bi-send me-2"></i>
                            Listas de Disparo
                        </h2>
                        <p class="mb-0 opacity-75">Gerencie suas listas de solicitações processadas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Stats -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar por nome da lista...">
                                </div>
                            </div>
                            <div class="col-md-2 text-center mt-2 mt-md-0">
                                <a href="/upload" class="btn btn-success btn-sm w-100">
                                    <i class="bi bi-plus-circle me-1"></i>
                                    Nova Lista
                                </a>
                            </div>
                            <div class="col-md-6 text-md-end mt-2 mt-md-0">
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all" checked>
                                    <label class="btn btn-outline-primary btn-sm" for="filterAll">Todas</label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterReady" value="Pronto para Disparo">
                                    <label class="btn btn-outline-success btn-sm" for="filterReady">Prontas</label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterProgress" value="Disparos em Andamento">
                                    <label class="btn btn-outline-warning btn-sm" for="filterProgress">Em Andamento</label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterPending" value="Aguardando Disparo">
                                    <label class="btn btn-outline-secondary btn-sm" for="filterPending">Aguardando</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div class="row justify-content-center" id="loadingState">
            <div class="col-lg-10">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-muted">Carregando listas...</p>
                </div>
            </div>
        </div>

        <!-- Sources Grid -->
        <div class="row justify-content-center d-none" id="sourcesContainer">
            <div class="col-lg-10">
                <div class="row" id="sourcesGrid">
                    <!-- Sources will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="row justify-content-center d-none" id="emptyState">
            <div class="col-lg-6">
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h3 class="mt-3">Nenhuma lista encontrada</h3>
                    <p class="text-muted">Ainda não há listas de PDFs processados.</p>
                    <a href="/upload" class="btn btn-custom">
                        <i class="bi bi-plus-circle me-2"></i>
                        Criar Nova Lista
                    </a>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div class="row justify-content-center d-none" id="errorState">
            <div class="col-lg-6">
                <div class="result-card result-error text-center">
                    <i class="bi bi-exclamation-triangle display-4 mb-3"></i>
                    <h4>Erro ao carregar listas</h4>
                    <p id="errorMessage" class="mb-3">Ocorreu um erro ao buscar as listas.</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-custom" onclick="loadSources()">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            Tentar Novamente
                        </button>
                        <a href="/upload" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i>
                            Criar Nova Lista
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuração de Disparo -->
    <div class="modal fade modal-config-disparo" id="modalConfigurarDisparo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                        <h5 class="modal-title mb-0">
                            <i class="bi bi-gear me-2"></i>
                            Configurar Disparo - <span id="modalSourceName"></span>
                        </h5>
                        <div class="d-flex gap-3 text-sm">
                            <span class="badge bg-primary" id="totalItensSource">0 itens</span>
                            <span class="badge bg-success" id="totalFiltrados">0 filtrados</span>
                            <span class="badge bg-warning" id="totalSelecionadosHeader">0 selecionados</span>
                            <span class="badge bg-info d-none" id="filtroDataAtivo">
                                <i class="bi bi-calendar-range me-1"></i>
                                Filtro Data
                            </span>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Buscar</label>
                            <input type="text" class="form-control form-control-sm" id="searchSolicitacoes" placeholder="Buscar contribuinte...">
                        </div>
                        <!-- <div class="col-md-3">
                            <label class="form-label">Situação</label>
                            <select class="form-select form-select-sm" id="filterSituacao">
                                <option value="">Todas</option>
                            </select>
                        </div> -->
                        <div class="col-md-3">
                            <label class="form-label">Status Disparo</label>
                            <select class="form-select form-select-sm" id="filterStatusDisparo">
                                <option value="">Todos</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ações em Lote -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button class="btn btn-outline-primary btn-sm me-2" onclick="selecionarTodos()">
                                        <i class="bi bi-check-square me-1"></i>
                                        Selecionar Todos
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="limparSelecao()">
                                        <i class="bi bi-square me-1"></i>
                                        Limpar Seleção
                                    </button>
                                </div>
                                <div>
                                    <span class="badge bg-info" id="contadorSelecionados">0 selecionados</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div class="text-center py-4 d-none" id="loadingSolicitacoes">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <small class="ms-2 text-muted">Carregando solicitações...</small>
                    </div>

                    <!-- Tabela de Solicitações -->
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="tabelaSolicitacoes">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" class="form-check-input" id="selectAllCheck">
                                    </th>
                                    <th width="80" style="cursor: pointer; user-select: none;" onclick="ordenarPorId()" title="Clique para ordenar por ID">
                                        ID
                                        <i id="iconeOrdenacaoId" class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                    </th>
                                    <th>Contribuinte</th>
                                    <th width="120">CCP</th>
                                    <th width="150">Valor Devido</th>
                                    <th>Processo(s)</th>
                                    <th style="cursor: pointer; user-select: none;" onclick="ordenarPorDataHora()" title="Clique para ordenar por Data/Hora">
                                        Data Cadastro
                                        <i id="iconeOrdenacao" class="bi bi-arrow-down-up ms-1 text-muted"></i>
                                    </th>
                                    <th>Status</th>
                                    <th>Telefone</th>
                                    <th width="200">Observação</th>
                                    <th width="80">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="corpoTabelaSolicitacoes">
                                <!-- Dados serão inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="btnIniciarDisparo">
                        <i class="bi bi-send me-2"></i>
                        Iniciar Disparo (<span id="totalSelecionados">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Atualizar Lista -->
    <div class="modal fade" id="modalAtualizarLista" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>
                        Atualizar Lista - <span id="modalAtualizarListaNome"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Atenção:</strong> Você pode adicionar novos registros a esta lista fazendo upload de um novo PDF. 
                        Os registros serão integrados à lista existente, evitando duplicatas.
                    </div>
                    
                    <!-- Upload Area -->
                    <div class="upload-area text-center p-4 border border-2 border-dashed rounded" id="uploadAreaModal">
                        <i class="bi bi-cloud-upload display-4 text-muted mb-3"></i>
                        <h5 class="mb-2">Arraste seu PDF aqui</h5>
                        <p class="text-muted mb-3">ou clique para selecionar</p>
                        <button type="button" class="btn btn-outline-primary" id="selectFileModalBtn">
                            <i class="bi bi-file-plus me-2"></i>
                            Selecionar Arquivo PDF
                        </button>
                        <input type="file" id="fileInputModal" class="d-none" accept=".pdf">
                    </div>

                    <!-- File Info -->
                    <div class="d-none mt-3" id="fileInfoModal">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="bi bi-file-earmark-pdf me-2 text-danger"></i>
                                            <span id="fileNameModal">arquivo.pdf</span>
                                        </h6>
                                        <small class="text-muted" id="fileSizeModal">0 KB</small>
                                    </div>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFileModal()">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress -->
                    <div class="d-none mt-3" id="progressContainerModal">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Processando arquivo...</span>
                            <span id="progressTextModal">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBarModal" 
                                 style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="d-none mt-3" id="resultsModal">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Sucesso!</strong> <span id="resultsTextModal">Arquivo processado com sucesso!</span>
                        </div>
                    </div>

                    <!-- Error -->
                    <div class="d-none mt-3" id="errorModal">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Erro:</strong> <span id="errorTextModal">Ocorreu um erro no processamento.</span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success d-none" id="processModalBtn">
                        <i class="bi bi-gear me-2"></i>
                        Processar e Atualizar Lista
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript Customizado -->
    <script>
        // Estado da aplicação
        let allSources = [];
        let filteredSources = [];

        // Elementos DOM
        const loadingState = document.getElementById('loadingState');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const sourcesGrid = document.getElementById('sourcesGrid');
        const emptyState = document.getElementById('emptyState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const searchInput = document.getElementById('searchInput');

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se está em modo de edição
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            
            if (editId) {
                loadDisparoForEdit(editId);
            } else {
                loadSources();
            }
            
            setupEventListeners();
            
            // Event listener global para checkboxes individuais das solicitações
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('solicitacao-check')) {
                    const id = parseInt(e.target.value);
                    if (e.target.checked) {
                        selectedSolicitacoes.add(id);
                    } else {
                        selectedSolicitacoes.delete(id);
                    }
                    atualizarContadores();
                }
            });
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Busca
            searchInput.addEventListener('input', debounce(filterSources, 300));
            
            // Filtros de status
            document.querySelectorAll('input[name="statusFilter"]').forEach(input => {
                input.addEventListener('change', filterSources);
            });
        }

        // Carregar sources da API
        async function loadSources() {
            showState('loading');
            
            try {
                const response = await fetch('/api/sources');
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    allSources = data.data;
                    filteredSources = [...allSources];
                    
                    if (allSources.length === 0) {
                        showState('empty');
                    } else {
                        renderSources();
                        showState('sources');
                    }
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('Erro ao carregar sources:', error);
                errorMessage.textContent = error.message;
                showState('error');
            }
        }

        // Carregar disparo para edição
        async function loadDisparoForEdit(disparoId) {
            showState('loading');
            
            try {
                // Carregar dados do disparo
                const disparoResponse = await fetch(`/api/disparos/${disparoId}`);
                
                if (!disparoResponse.ok) {
                    throw new Error(`Erro ao carregar disparo: ${disparoResponse.status}`);
                }
                
                const disparoData = await disparoResponse.json();
                
                if (disparoData.status !== 'success') {
                    throw new Error(disparoData.message || 'Erro ao carregar disparo');
                }
                
                const disparo = disparoData.data;
                
                // Carregar sources
                const sourcesResponse = await fetch('/api/sources');
                
                if (!sourcesResponse.ok) {
                    throw new Error(`Erro ao carregar sources: ${sourcesResponse.status}`);
                }
                
                const sourcesData = await sourcesResponse.json();
                
                if (sourcesData.status !== 'success') {
                    throw new Error(sourcesData.message || 'Erro ao carregar sources');
                }
                
                allSources = sourcesData.data;
                filteredSources = [...allSources];
                
                // Renderizar sources
                if (allSources.length === 0) {
                    showState('empty');
                } else {
                    renderSources();
                    showState('sources');
                    
                    // Selecionar a source do disparo automaticamente
                    setTimeout(() => {
                        selectSource(disparo.source_id);
                        
                        // Preencher dados do disparo nos campos
                        document.querySelector('#modalConfiguracaoDisparo h5').textContent = 'Editar Disparo';
                        document.getElementById('tituloDisparo').value = disparo.titulo || '';
                        document.getElementById('descricaoDisparo').value = disparo.descricao || '';
                        
                        // Pré-selecionar solicitações que estão no disparo
                        const solicitacaoIds = disparo.solicitacoes.map(s => s.solicitacao_id);
                        solicitacaoIds.forEach(id => {
                            const checkbox = document.querySelector(`input[value="${id}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                        
                        // Atualizar contadores
                        updateSelectedCount();
                        
                        // Adicionar classe para identificar modo edição
                        document.body.dataset.editMode = disparoId;
                        
                        // Atualizar textos da interface para modo edição
                        document.title = 'Editar Disparo - Morrinhos';
                        document.querySelector('h2.mb-1').textContent = 'Editar Disparo';
                        document.querySelector('.card-header p').textContent = 'Modifique os dados do disparo e salve as alterações';
                        
                        // Atualizar botão
                        const btnIniciarDisparo = document.getElementById('btnIniciarDisparo');
                        if (btnIniciarDisparo) {
                            btnIniciarDisparo.innerHTML = '<i class="bi bi-save me-2"></i>Salvar Alterações (<span id="totalSelecionados">0</span>)';
                        }
                        
                        // Mostrar toast informativo
                        mostrarToast('Disparo carregado para edição. Modifique os dados e salve as alterações.', 'info');
                        
                    }, 500);
                }
                
            } catch (error) {
                console.error('Erro ao carregar disparo para edição:', error);
                errorMessage.textContent = error.message;
                showState('error');
            }
        }

        // Mostrar diferentes estados da interface
        function showState(state) {
            loadingState.classList.add('d-none');
            sourcesContainer.classList.add('d-none');
            emptyState.classList.add('d-none');
            errorState.classList.add('d-none');
            
            switch (state) {
                case 'loading':
                    loadingState.classList.remove('d-none');
                    break;
                case 'sources':
                    sourcesContainer.classList.remove('d-none');
                    break;
                case 'empty':
                    emptyState.classList.remove('d-none');
                    break;
                case 'error':
                    errorState.classList.remove('d-none');
                    break;
            }
        }

        // Renderizar sources na grade
        function renderSources() {
            sourcesGrid.innerHTML = '';
            
            if (filteredSources.length === 0) {
                sourcesGrid.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-4">
                            <i class="bi bi-search display-4 text-muted"></i>
                            <h5 class="mt-3">Nenhum resultado encontrado</h5>
                            <p class="text-muted">Tente ajustar os filtros de busca.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            filteredSources.forEach(source => {
                const sourceCard = createSourceCard(source);
                sourcesGrid.appendChild(sourceCard);
            });
        }

        // Criar card para uma source
        function createSourceCard(source) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-4';
            
            const statusClass = getStatusClass(source.status_processamento);
            const statusIcon = getStatusIcon(source.status_processamento);
            const dataUpload = new Date(source.data_upload).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            col.innerHTML = `
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-0 text-truncate" title="${source.nome}">${source.nome}</h6>
                            <span class="badge ${statusClass} ms-2">
                                <i class="${statusIcon} me-1"></i>
                                ${source.status_processamento}
                            </span>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Devedores</small>
                                <strong class="h5 mb-0">${source.quantidade_itens}</strong>
                                <small class="text-muted">registros</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Data Upload</small>
                                <small class="fw-bold">${dataUpload}</small>
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Disparos Enviados</small>
                                <span class="badge bg-primary">${source.registros_processados}</span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Aguardando Disparo</small>
                                <span class="badge bg-warning">${source.quantidade_itens - source.registros_processados}</span>
                            </div>
                        </div>
                        
                        <!-- Progress Bars -->
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Extração</small>
                                <small class="fw-bold">${source.porcentagem_extracao}%</small>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar bg-info" 
                                     style="width: ${source.porcentagem_extracao}%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Disparos</small>
                                <small class="fw-bold">${source.porcentagem_disparo}%</small>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar ${getProgressBarClass(source.porcentagem_disparo)}" 
                                     style="width: ${source.porcentagem_disparo}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-white border-top-0">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="configurarDisparo(${source.id})">
                                <i class="bi bi-gear me-1"></i>
                                Configurar Disparo
                            </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="excluirLista(${source.id}, '${source.nome}')" title="Excluir lista">
                                    <i class="bi bi-trash"></i>
                                </button>
                            <!-- <div class="d-flex gap-2 mt-1">
                                <button class="btn btn-outline-success btn-sm flex-grow-1" onclick="atualizarLista(${source.id}, '${source.nome}')">
                                    <i class="bi bi-plus-circle me-1"></i>
                                    Atualizar Lista
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="excluirLista(${source.id}, '${source.nome}')" title="Excluir lista">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div> -->
                        </div>
                    </div>
                </div>
            `;
            return col;
        }

        // Filtrar sources
        function filterSources() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusFilter = document.querySelector('input[name="statusFilter"]:checked').value;
            
            filteredSources = allSources.filter(source => {
                const matchesSearch = source.nome.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || source.status_processamento === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            renderSources();
        }

        // Funções utilitárias
        function getStatusClass(status) {
            switch (status) {
                case 'Disparos Concluídos': return 'bg-success';
                case 'Disparos em Andamento': return 'bg-warning';
                case 'Processando Disparos': return 'bg-info';
                case 'Pronto para Disparo': return 'bg-primary';
                case 'Aguardando Disparo': return 'bg-secondary';
                case 'Sem Dados Extraídos': return 'bg-danger';
                case 'Extração Incompleta': return 'bg-warning';
                case 'Concluído': return 'bg-success';
                default: return 'bg-secondary';
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'Disparos Concluídos': return 'bi bi-check-circle-fill';
                case 'Disparos em Andamento': return 'bi bi-clock-fill';
                case 'Processando Disparos': return 'bi bi-gear-fill';
                case 'Pronto para Disparo': return 'bi bi-play-circle-fill';
                case 'Aguardando Disparo': return 'bi bi-pause-circle-fill';
                case 'Sem Dados Extraídos': return 'bi bi-exclamation-triangle-fill';
                case 'Extração Incompleta': return 'bi bi-hourglass-split';
                case 'Concluído': return 'bi bi-check-circle-fill';
                default: return 'bi bi-question-circle-fill';
            }
        }

        function getProgressBarClass(percentage) {
            if (percentage === 100) return 'bg-success';
            if (percentage >= 50) return 'bg-warning';
            return 'bg-secondary';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Formatar data e hora para exibição
        function formatarDataHora(dataISO) {
            const date = new Date(dataISO);
            const dia = date.getDate().toString().padStart(2, '0');
            const mes = (date.getMonth() + 1).toString().padStart(2, '0');
            const ano = date.getFullYear();
            const horas = date.getHours().toString().padStart(2, '0');
            const minutos = date.getMinutes().toString().padStart(2, '0');
            
            // Formato: DD/MM/AAAA - HH:MM (ex: 14/08/2025 - 10:14)
            return `${dia}/${mes}/${ano} - ${horas}:${minutos}`;
        }

        // Mostrar toast de notificação
        function mostrarToast(mensagem, tipo = 'info') {
            // Remover toast anterior se existir
            const existingToast = document.getElementById('customToast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Criar toast
            const toast = document.createElement('div');
            toast.id = 'customToast';
            toast.className = `alert alert-${tipo} position-fixed`;
            toast.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease-out;
            `;
            
            const iconClass = tipo === 'success' ? 'bi-check-circle-fill' : 
                             tipo === 'danger' ? 'bi-exclamation-triangle-fill' : 
                             tipo === 'warning' ? 'bi-exclamation-triangle-fill' : 
                             'bi-info-circle-fill';
                             
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi ${iconClass} me-2"></i>
                    <span>${mensagem}</span>
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remover após 5 segundos
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        // Configurar disparo de uma source
        function configurarDisparo(sourceId) {
            const source = allSources.find(s => s.id === sourceId);
            if (!source) {
                alert('Source não encontrada!');
                return;
            }

            // Atualizar título do modal
            document.getElementById('modalSourceName').textContent = source.nome;
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('modalConfigurarDisparo'));
            modal.show();
            
            // Carregar solicitações da source
            carregarSolicitacoes(sourceId);
        }

        // Variáveis globais para o modal
        let currentSourceId = null;
        let allSolicitacoes = [];
        let filteredSolicitacoes = [];
        let selectedSolicitacoes = new Set();
        
        // Variáveis para controle da ordenação
        let ordenacaoAtual = 'desc'; // 'asc' ou 'desc' - começa com mais recente primeiro
        let colunaOrdenacao = 'data_hora';

        // Carregar solicitações de uma source
        async function carregarSolicitacoes(sourceId) {
            currentSourceId = sourceId;
            const loadingElement = document.getElementById('loadingSolicitacoes');
            const tableElement = document.getElementById('tabelaSolicitacoes');
            
            loadingElement.classList.remove('d-none');
            tableElement.classList.add('d-none');
            
            try {
                const response = await fetch(`/api/sources/${sourceId}/solicitacoes`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    allSolicitacoes = data.solicitacoes;
                    filteredSolicitacoes = [...allSolicitacoes];
                    
                    console.log('Solicitações carregadas:', allSolicitacoes.length);
                    
                    // Popular filtros
                    popularFiltros();
                    
                    // Atualizar ícone de ordenação para mostrar estado inicial
                    const icone = document.getElementById('iconeOrdenacao');
                    if (icone) {
                        icone.className = 'bi bi-arrow-down ms-1 text-primary';
                        icone.title = 'Ordenado: mais recente primeiro';
                    }
                    
                    // Renderizar tabela
                    renderizarTabelaSolicitacoes();
                    
                    // Atualizar contadores
                    atualizarContadores();
                    
                    // Configurar event listeners do modal
                    setupModalEventListeners();
                    
                } else {
                    throw new Error(data.message || 'Erro ao carregar solicitações');
                }
                
            } catch (error) {
                console.error('Erro ao carregar solicitações:', error);
                alert('Erro ao carregar solicitações: ' + error.message);
            } finally {
                loadingElement.classList.add('d-none');
                tableElement.classList.remove('d-none');
            }
        }

        // Popular filtros com valores únicos
        function popularFiltros() {
            // const situacoes = [...new Set(allSolicitacoes.map(s => s.situacao).filter(Boolean))];
            const statusDisparo = [...new Set(allSolicitacoes.map(s => s.status).filter(Boolean))];
            
            console.log('Status de disparo disponíveis:', statusDisparo);
            
            //popularSelect('filterSituacao', situacoes);
            popularSelect('filterStatusDisparo', statusDisparo);
        }

        function popularSelect(selectId, opcoes) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.warn(`Elemento ${selectId} não encontrado`);
                return;
            }
            
            // Se for um campo de entrada de texto com datalist (caso do filterUnidade)
            if (select.tagName.toLowerCase() === 'input' && select.getAttribute('list')) {
                const datalistId = select.getAttribute('list');
                const datalist = document.getElementById(datalistId);
                
                if (datalist) {
                    // Limpar datalist e adicionar opções
                    datalist.innerHTML = '';
                    
                    opcoes.forEach(opcao => {
                        if (opcao && opcao.trim() !== '') {
                            const option = document.createElement('option');
                            option.value = opcao;
                            datalist.appendChild(option);
                        }
                    });
                }
            } 
            // Se for um select normal
            else if (select.tagName.toLowerCase() === 'select') {
                select.innerHTML = '<option value="">Todos</option>';
                
                opcoes.forEach(opcao => {
                    if (opcao && opcao.trim() !== '') {
                        const option = document.createElement('option');
                        option.value = opcao;
                        option.textContent = opcao;
                        select.appendChild(option);
                    }
                });
            }
        }

        // Renderizar tabela de solicitações
        function renderizarTabelaSolicitacoes() {
            const tbody = document.getElementById('corpoTabelaSolicitacoes');
            tbody.innerHTML = '';
            
            filteredSolicitacoes.forEach(solicitacao => {
                const row = criarLinhaSolicitacao(solicitacao);
                tbody.appendChild(row);
            });
            
            atualizarContadores();
        }

        // Criar linha da tabela para um devedor
        function criarLinhaSolicitacao(devedor) {
            const tr = document.createElement('tr');
            const isSelected = selectedSolicitacoes.has(devedor.id);
            
            // Formatar valor devido
            const valorFormatado = parseFloat(devedor.valor_devido || 0).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
            
            tr.innerHTML = `
                <td>
                    <input type="checkbox" class="form-check-input solicitacao-check" 
                           value="${devedor.id}" ${isSelected ? 'checked' : ''}>
                </td>
                <td>
                    <small class="text-muted">#${devedor.id}</small>
                </td>
                <td>${devedor.contribuinte || devedor.paciente || '-'}</td>
                <td>
                    <small class="text-primary font-monospace">${devedor.ccp || devedor.identificacao_paciente || '-'}</small>
                </td>
                <td>
                    <strong class="text-success">${valorFormatado}</strong>
                </td>
                <td class="text-truncate" title="${devedor.processo || ''}" style="max-width: 200px;">
                    ${devedor.processo || devedor.procedimento || '-'}
                </td>
                <td>${formatarDataHora(devedor.data_hora || devedor.created_at)}</td>
                <td>
                    <span class="badge ${getStatusDevedorClass(devedor.status)}">
                        ${getStatusDevedorLabel(devedor.status)}
                    </span>
                </td>
                <td>${devedor.celular || devedor.celular_telefone || '-'}</td>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <textarea class="form-control form-control-sm observacao-input" 
                                  data-solicitacao-id="${devedor.id}" 
                                  rows="2" 
                                  style="min-width: 200px; resize: vertical;"
                                  placeholder="Adicionar observação..."
                                  title="Digite uma observação">${devedor.observacao || ''}</textarea>
                        <button class="btn btn-outline-primary btn-sm observacao-btn" 
                                onclick="salvarObservacao(${devedor.id})" 
                                title="Salvar observação">
                            <i class="bi bi-save"></i>
                        </button>
                    </div>
                </td>
                <td>
                    <button class="btn btn-outline-info btn-sm" onclick="verDetalhesDevedor(${devedor.id})" 
                            title="Ver detalhes">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            `;
            
            return tr;
        }

        // Funções auxiliares para status de devedor
        function getStatusDevedorClass(status) {
            switch (status) {
                case 'ativo': return 'bg-warning';
                case 'enviado': return 'bg-primary';
                case 'pago': return 'bg-success';
                case 'cancelado': return 'bg-secondary';
                case 'erro': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function getStatusDevedorLabel(status) {
            switch (status) {
                case 'ativo': return 'Ativo';
                case 'enviado': return 'Enviado';
                case 'pago': return 'Pago';
                case 'cancelado': return 'Cancelado';
                case 'erro': return 'Erro';
                default: return 'Pendente';
            }
        }

        // Função para ver detalhes do devedor
        function verDetalhesDevedor(devedorId) {
            const devedor = allSolicitacoes.find(d => d.id === devedorId);
            if (!devedor) {
                alert('Devedor não encontrado!');
                return;
            }

            const valorFormatado = parseFloat(devedor.valor_devido || 0).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });

            const detalhes = `
Contribuinte: ${devedor.contribuinte || devedor.paciente}
CCP: ${devedor.ccp || devedor.identificacao_paciente}
Valor Devido: ${valorFormatado}
Processo(s): ${devedor.processo || devedor.procedimento || 'N/A'}
Telefone: ${devedor.celular || devedor.celular_telefone || 'N/A'}
Status: ${getStatusDevedorLabel(devedor.status)}
Data Cadastro: ${formatarDataHora(devedor.created_at)}
Observação: ${devedor.observacao || 'Nenhuma'}
            `;

            alert(detalhes);
        }

        // Funções auxiliares para status de disparo
        function getStatusDisparoClass(status) {
            switch (status) {
                case 'pendente': return 'bg-secondary';
                case 'em_fila': return 'bg-warning';
                case 'enviado': return 'bg-primary';
                case 'respondido': return 'bg-info';
                case 'agendado': return 'bg-success';
                case 'rejeitado': return 'bg-danger';
                case 'sem_resposta': return 'bg-warning';
                case 'cancelado': return 'bg-dark';
                case 'erro': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function getStatusDisparoLabel(status) {
            switch (status) {
                case 'pendente': return 'Pendente';
                case 'em_fila': return 'Em Fila';
                case 'enviado': return 'Enviado';
                case 'respondido': return 'Respondido';
                case 'agendado': return 'Agendado';
                case 'rejeitado': return 'Rejeitado';
                case 'sem_resposta': return 'Sem Resposta';
                case 'cancelado': return 'Cancelado';
                case 'erro': return 'Erro';
                default: return 'Desconhecido';
            }
        }

        // Função auxiliar para classificação de risco
        function getClassificacaoRiscoClass(classificacao) {
            if (!classificacao || classificacao === '-') return 'bg-secondary';
            
            const classificacaoUpper = classificacao.toUpperCase().trim();
            
            // Sistema de cores baseado na urgência (do mais urgente para o menos urgente)
            
            // Vermelho - EMERGÊNCIA (mais crítico)
            if (classificacaoUpper === 'EMERGÊNCIA' || classificacaoUpper === 'EMERGENCIA') {
                return 'bg-danger';
            }
            
            // Laranja escuro - MUITO URGENTE (segundo mais crítico)
            if (classificacaoUpper === 'MUITO URGENTE') {
                return 'bg-warning text-dark';
            }
            
            // Amarelo - URGENTE (terceiro nível de urgência)
            if (classificacaoUpper === 'URGENTE') {
                return 'bg-warning';
            }
            
            // Azul claro - POUCO URGENTE (quarto nível)
            if (classificacaoUpper === 'POUCO URGENTE') {
                return 'bg-info';
            }
            
            // Verde - NÃO URGENTE (menos crítico)
            if (classificacaoUpper === 'NAO URGENTE' || classificacaoUpper === 'NÃO URGENTE') {
                return 'bg-success';
            }
            
            // Padrão para classificações não reconhecidas
            return 'bg-secondary';
        }

        // Configurar event listeners do modal
        function setupModalEventListeners() {
            // Remover event listeners anteriores para evitar duplicação
            const elements = [
                'searchSolicitacoes',
                //'filterSituacao',
                'filterStatusDisparo'
            ];
            
            elements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    // Clonar o elemento para remover todos os event listeners
                    const newElement = element.cloneNode(true);
                    element.parentNode.replaceChild(newElement, element);
                }
            });
            
            // Busca
            const searchElement = document.getElementById('searchSolicitacoes');
            if (searchElement) {
                searchElement.addEventListener('input', debounce(filtrarSolicitacoes, 300));
            }
            
            // Filtros
            //document.getElementById('filterSituacao').addEventListener('change', filtrarSolicitacoes);
            const statusFilterElement = document.getElementById('filterStatusDisparo');
            if (statusFilterElement) {
                statusFilterElement.addEventListener('change', filtrarSolicitacoes);
            }
            
            // Select all
            const selectAllCheck = document.getElementById('selectAllCheck');
            if (selectAllCheck) {
                const newSelectAll = selectAllCheck.cloneNode(true);
                selectAllCheck.parentNode.replaceChild(newSelectAll, selectAllCheck);
                
                newSelectAll.addEventListener('change', function() {
                    const isChecked = this.checked;
                    document.querySelectorAll('.solicitacao-check').forEach(check => {
                        check.checked = isChecked;
                        if (isChecked) {
                            selectedSolicitacoes.add(parseInt(check.value));
                        } else {
                            selectedSolicitacoes.delete(parseInt(check.value));
                        }
                    });
                    atualizarContadores();
                });
            }
            
            console.log('Event listeners configurados para filtros');
        }

        // Filtrar solicitações
        function filtrarSolicitacoes() {
            const searchTerm = document.getElementById('searchSolicitacoes')?.value?.toLowerCase() || '';
            const statusDisparo = document.getElementById('filterStatusDisparo')?.value || '';
            
            console.log('Aplicando filtros:', {
                searchTerm,
                statusDisparo
            });
            
            filteredSolicitacoes = allSolicitacoes.filter(sol => {
                const matchesSearch = (sol.contribuinte || '').toLowerCase().includes(searchTerm) ||
                                    (sol.ccp || '').toLowerCase().includes(searchTerm);
                
                // Filtro de status de disparo
                const matchesStatusDisparo = !statusDisparo || sol.status === statusDisparo;
                
                const result = matchesSearch && matchesStatusDisparo;
                
                return result;
            });
            
            console.log(`Filtros aplicados: ${allSolicitacoes.length} -> ${filteredSolicitacoes.length} solicitações`);
            
            renderizarTabelaSolicitacoes();
            atualizarContadores();
        }
        
        // Função para ordenar por ID
        function ordenarPorId() {
            // Definir coluna de ordenação
            colunaOrdenacao = 'id';
            
            // Alternar entre ascendente e descendente
            ordenacaoAtual = ordenacaoAtual === 'asc' ? 'desc' : 'asc';
            
            // Atualizar ícone do ID
            const iconeId = document.getElementById('iconeOrdenacaoId');
            if (iconeId) {
                if (ordenacaoAtual === 'asc') {
                    iconeId.className = 'bi bi-arrow-up ms-1 text-primary';
                    iconeId.title = 'Ordenado: menor ID primeiro';
                } else {
                    iconeId.className = 'bi bi-arrow-down ms-1 text-primary';
                    iconeId.title = 'Ordenado: maior ID primeiro';
                }
            }
            
            // Re-renderizar tabela
            renderizarTabelaSolicitacoes();
            
            console.log(`Ordenação aplicada: ${ordenacaoAtual} por ${colunaOrdenacao}`);
        }
        

        // Funções de seleção
        function selecionarTodos() {
            filteredSolicitacoes.forEach(sol => selectedSolicitacoes.add(sol.id));
            document.querySelectorAll('.solicitacao-check').forEach(check => check.checked = true);
            document.getElementById('selectAllCheck').checked = true;
            atualizarContadores();
        }

        function limparSelecao() {
            selectedSolicitacoes.clear();
            document.querySelectorAll('.solicitacao-check').forEach(check => check.checked = false);
            document.getElementById('selectAllCheck').checked = false;
            atualizarContadores();
        }

        // Atualizar contadores
        function atualizarContadores() {
            const count = selectedSolicitacoes.size;
            const totalItens = allSolicitacoes.length;
            const totalFiltrados = filteredSolicitacoes.length;
            
            // Verificar se os elementos existem antes de atualizar
            const contadorSelecionados = document.getElementById('contadorSelecionados');
            if (contadorSelecionados) {
                contadorSelecionados.textContent = `${count} selecionados`;
            }
            
            const totalSelecionados = document.getElementById('totalSelecionados');
            if (totalSelecionados) {
                totalSelecionados.textContent = count;
            }
            
            const btnIniciarDisparo = document.getElementById('btnIniciarDisparo');
            if (btnIniciarDisparo) {
                btnIniciarDisparo.disabled = count === 0;
            }
            
            // Atualizar badges no cabeçalho
            const totalItensSource = document.getElementById('totalItensSource');
            if (totalItensSource) {
                totalItensSource.textContent = `${totalItens} itens`;
            }
            
            const totalFiltradosEl = document.getElementById('totalFiltrados');
            if (totalFiltradosEl) {
                totalFiltradosEl.textContent = `${totalFiltrados} filtrados`;
            }
            
            const totalSelecionadosHeader = document.getElementById('totalSelecionadosHeader');
            if (totalSelecionadosHeader) {
                totalSelecionadosHeader.textContent = `${count} selecionados`;
            }
            
            // Atualizar badge de filtro de data
            const filtroDataAtivo = document.getElementById('filtroDataAtivo');
            const dataInicial = document.getElementById('filterDataInicial')?.value;
            const dataFinal = document.getElementById('filterDataFinal')?.value;
            
            if (filtroDataAtivo) {
                if (dataInicial || dataFinal) {
                    filtroDataAtivo.classList.remove('d-none');
                    let textoFiltro = 'Filtro Data';
                    if (dataInicial && dataFinal) {
                        const dataIni = new Date(dataInicial).toLocaleDateString('pt-BR');
                        const dataFim = new Date(dataFinal).toLocaleDateString('pt-BR');
                        textoFiltro = `${dataIni} - ${dataFim}`;
                    } else if (dataInicial) {
                        const dataIni = new Date(dataInicial).toLocaleDateString('pt-BR');
                        textoFiltro = `A partir de ${dataIni}`;
                    } else if (dataFinal) {
                        const dataFim = new Date(dataFinal).toLocaleDateString('pt-BR');
                        textoFiltro = `Até ${dataFim}`;
                    }
                    filtroDataAtivo.innerHTML = `<i class="bi bi-calendar-range me-1"></i>${textoFiltro}`;
                } else {
                    filtroDataAtivo.classList.add('d-none');
                }
            }
        }

        // Iniciar disparo
        document.getElementById('btnIniciarDisparo').addEventListener('click', async function() {
            if (selectedSolicitacoes.size === 0) {
                alert('Selecione pelo menos uma solicitação para iniciar o disparo.');
                return;
            }

            // Verificar se está em modo edição
            const editMode = document.body.dataset.editMode;
            const isEdit = !!editMode;

            // Criar modal de confirmação com input para nome
            const disparoData = await mostrarModalConfirmacaoDisparo();
            if (!disparoData) return;

            try {
                // Desabilitar botão durante o processo
                this.disabled = true;
                this.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${isEdit ? 'Salvando...' : 'Criando...'}`;

                // Obter configuração dos filtros aplicados
                const configuracao = {
                    filtros: {
                        busca: document.getElementById('searchSolicitacoes')?.value || '',
                        statusDisparo: document.getElementById('filterStatusDisparo')?.value || ''
                    },
                    timestamp: new Date().toISOString()
                };

                const requestData = {
                    nome: disparoData.nome,
                    descricao: disparoData.descricao,
                    source_id: currentSourceId,
                    solicitacoes_ids: Array.from(selectedSolicitacoes),
                    configuracao: configuracao
                };

                // Configurar URL e método baseado no modo
                const url = isEdit ? `/api/disparos/${editMode}` : '/api/disparos';
                const method = isEdit ? 'PUT' : 'POST';

                // Criar/Atualizar disparo via API
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (response.ok) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfigurarDisparo'));
                    if (modal) {
                        modal.hide();
                    }

                    // Mostrar sucesso
                    const action = isEdit ? 'atualizado' : 'criado';
                    alert(`✅ Disparo "${disparoData.nome}" ${action} com sucesso!\nID: ${result.data.id}\nSolicitações: ${selectedSolicitacoes.size}`);

                    // Se for edição, redirecionar para a lista de disparos
                    if (isEdit) {
                        window.location.href = '/disparos';
                    } else {
                        // Limpar seleção apenas se for criação nova
                        selectedSolicitacoes.clear();
                        atualizarContadores();
                    }

                } else {
                    throw new Error(result.message || `Erro ao ${isEdit ? 'atualizar' : 'criar'} disparo`);
                }

            } catch (error) {
                console.error(`Erro ao ${isEdit ? 'atualizar' : 'criar'} disparo:`, error);
                alert(`❌ Erro ao ${isEdit ? 'atualizar' : 'criar'} disparo: ` + error.message);
            } finally {
                // Reabilitar botão
                this.disabled = false;
                const action = document.body.dataset.editMode ? 'Salvar' : 'Iniciar';
                this.innerHTML = `<i class="bi bi-${document.body.dataset.editMode ? 'save' : 'send'} me-2"></i>${action} Disparo (<span id="totalSelecionados">0</span>)`;
                
                // Aguardar um momento para o DOM ser atualizado e verificar se elementos existem
                setTimeout(() => {
                    const totalSelecionados = document.getElementById('totalSelecionados');
                    if (totalSelecionados) {
                        atualizarContadores(); // Para atualizar o contador no botão
                    } else {
                        console.warn('Elemento totalSelecionados não encontrado, aguardando mais tempo...');
                        setTimeout(atualizarContadores, 200);
                    }
                }, 100);
            }
        });

        // Salvar observação individual
        async function salvarObservacao(solicitacaoId) {
            const textarea = document.querySelector(`textarea[data-solicitacao-id="${solicitacaoId}"]`);
            const observacao = textarea.value.trim();
            
            try {
                // Desabilitar botão e textarea durante o salvamento
                const btn = event.target.closest('button');
                const originalBtnContent = btn.innerHTML;
                
                btn.disabled = true;
                textarea.disabled = true;
                btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
                
                const response = await fetch(`/api/solicitacoes/${solicitacaoId}/observacao`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        observacao: observacao
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Atualizar dados locais
                    const solicitacao = allSolicitacoes.find(s => s.id === solicitacaoId);
                    if (solicitacao) {
                        solicitacao.observacao = observacao;
                    }
                    
                    // Feedback visual de sucesso
                    btn.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                    textarea.classList.add('border-success');
                    
                    // Mostrar toast de sucesso
                    mostrarToast('Observação salva com sucesso!', 'success');
                    
                    // Restaurar botão após 2 segundos
                    setTimeout(() => {
                        btn.disabled = false;
                        textarea.disabled = false;
                        btn.innerHTML = originalBtnContent;
                        textarea.classList.remove('border-success');
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || 'Erro ao salvar observação');
                }
                
            } catch (error) {
                console.error('Erro ao salvar observação:', error);
                mostrarToast('Erro ao salvar observação: ' + error.message, 'danger');
                
                // Restaurar controles em caso de erro
                const btn = event.target.closest('button');
                const textarea = document.querySelector(`textarea[data-solicitacao-id="${solicitacaoId}"]`);
                
                btn.disabled = false;
                textarea.disabled = false;
                btn.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-danger"></i>';
                textarea.classList.add('border-danger');
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="bi bi-save"></i>';
                    textarea.classList.remove('border-danger');
                }, 3000);
            }
        }

        // Salvar unidade do paciente
        
        async function salvarUnidade(solicitacaoId, btnElement) {
            // Abordagem simplificada - buscar elementos no contexto da linha
            let container, select, customInput, btn;
            
            if (btnElement) {
                // Buscar na mesma linha (tr) do botão clicado
                const row = btnElement.closest('tr');
                if (row) {
                    container = row.querySelector('.unidade-container');
                    select = row.querySelector('.unidade-select');
                    customInput = row.querySelector('.unidade-custom-input');
                    btn = row.querySelector('.unidade-btn');
                }
            }
            
            // Fallback - buscar globalmente se não encontrou na linha
            if (!container || !select || !customInput || !btn) {
                select = document.querySelector(`select[data-solicitacao-id="${solicitacaoId}"]`);
                customInput = document.querySelector(`input[data-solicitacao-id="${solicitacaoId}"].unidade-custom-input`);
                btn = document.querySelector(`button[onclick*="salvarUnidade(${solicitacaoId}"]`);
                
                if (select) {
                    container = select.closest('.unidade-container');
                }
            }
            
            console.log('Elementos encontrados:', {
                container: !!container,
                select: !!select,
                customInput: !!customInput,
                btn: !!btn,
                solicitacaoId: solicitacaoId
            });
            
            if (!select || !customInput || !btn) {
                console.error('Elementos não encontrados:', { select: !!select, customInput: !!customInput, btn: !!btn });
                mostrarToast('Erro: Elementos da interface não encontrados', 'danger');
                return;
            }
            
            // Determinar qual valor usar (dropdown ou input personalizado)
            let unidade;
            
            if (select.value === '__custom__') {
                // Se "Adicionar nova..." está selecionado, use o valor do campo de texto
                unidade = customInput.value.trim();
            } else {
                // Caso contrário, use o valor do dropdown
                unidade = select.value;
            }
            
            if (!unidade) {
                mostrarToast('Por favor, selecione ou digite a unidade.', 'warning');
                return;
            }
            
            try {
                // Desabilitar botão durante o salvamento
                const originalContent = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
                
                const response = await fetch(`/api/solicitacoes/${solicitacaoId}/unidade`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        unidade: unidade
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Atualizar dados locais
                    const solicitacao = allSolicitacoes.find(s => s.id === solicitacaoId);
                    if (solicitacao) {
                        solicitacao.unidade = unidade;
                    }
                    
                    // Feedback visual de sucesso
                    btn.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                    
                    // Se for unidade personalizada, adicionar às opções e selecionar no dropdown
                    if (select.value === '__custom__') {
                        adicionarOpcaoUnidade(unidade);
                        
                        // Selecionar a nova opção no dropdown
                        const existingOption = select.querySelector(`option[value="${unidade}"]`);
                        if (existingOption) {
                            existingOption.selected = true;
                        }
                        
                        // Esconder o campo de texto personalizado
                        customInput.classList.add('d-none');
                        customInput.value = '';
                        select.classList.add('border-success');
                    } else {
                        select.classList.add('border-success');
                    }
                    
                    // Mostrar toast de sucesso
                    mostrarToast('Unidade salva com sucesso!', 'success');
                    
                    // Restaurar botão após 2 segundos
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                        select.classList.remove('border-success');
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || 'Erro ao salvar unidade');
                }
                
            } catch (error) {
                console.error('Erro ao salvar unidade:', error);
                mostrarToast('Erro ao salvar unidade: ' + error.message, 'danger');
                
                // Restaurar controles em caso de erro
                const btn = container.querySelector('.unidade-btn');
                
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-danger"></i>';
                    
                    setTimeout(() => {
                        btn.innerHTML = '<i class="bi bi-save"></i>';
                    }, 3000);
                }
                
                if (select.value === '__custom__') {
                    customInput.classList.add('border-danger');
                } else {
                    select.classList.add('border-danger');
                }
                
                setTimeout(() => {
                    customInput.classList.remove('border-danger');
                    select.classList.remove('border-danger');
                }, 3000);
            }
        }
        
        // Função para lidar com mudanças no dropdown de unidade
        function handleUnidadeChange(selectElement, solicitacaoId) {
            const container = selectElement.closest('.unidade-container');
            const customInput = container.querySelector('.unidade-custom-input');
            
            if (selectElement.value === '__custom__') {
                // Mostrar campo de entrada personalizada
                customInput.classList.remove('d-none');
                customInput.focus();
                customInput.placeholder = 'Digite a nova unidade...';
            } else {
                // Ocultar campo de entrada personalizada
                customInput.classList.add('d-none');
                customInput.value = '';
                
                // Se uma opção válida foi selecionada, salvar automaticamente
                if (selectElement.value !== '') {
                    // Pequeno delay para permitir que a UI se atualize
                    setTimeout(() => {
                        salvarUnidade(solicitacaoId);
                    }, 100);
                }
            }
        }
        
        // Função para adicionar uma nova opção de unidade a todos os dropdowns
        function adicionarOpcaoUnidade(unidade) {
            if (!unidade) return;
            
            // Valores padrão que não devem ser duplicados
            const valoresPadrao = ['', '__custom__', 'Clínica da Mulher', 'Hospital Municipal'];
            
            if (valoresPadrao.includes(unidade)) {
                return; // Não adicione valores padrão novamente
            }
            
            // Verificar se a unidade já existe no filtro de unidade
            const filterInput = document.getElementById('filterUnidade');
            let opcaoExiste = false;
            
            // Verificar se já existe no input de filtro
            if (filterInput && filterInput.getAttribute('list')) {
                const datalistId = filterInput.getAttribute('list');
                const datalist = document.getElementById(datalistId);
                
                if (datalist) {
                    for (let i = 0; i < datalist.options.length; i++) {
                        if (datalist.options[i].value === unidade) {
                            opcaoExiste = true;
                            break;
                        }
                    }
                    
                    // Se não existe, adicionar à datalist do filtro
                    if (!opcaoExiste) {
                        const option = document.createElement('option');
                        option.value = unidade;
                        datalist.appendChild(option);
                        console.log(`Nova unidade "${unidade}" adicionada ao filtro`);
                    }
                }
            }
            
            // Adicionar a todos os dropdowns de seleção de unidade
            document.querySelectorAll('.unidade-select').forEach(select => {
                opcaoExiste = false;
                
                // Verificar se já existe no select
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === unidade) {
                        opcaoExiste = true;
                        break;
                    }
                }
                
                // Se não existe, adicionar ao select
                if (!opcaoExiste) {
                    // Inserir antes da opção "Adicionar nova..."
                    const customOption = select.querySelector('option[value="__custom__"]');
                    const newOption = document.createElement('option');
                    newOption.value = unidade;
                    newOption.textContent = unidade;
                    
                    if (customOption) {
                        select.insertBefore(newOption, customOption);
                    } else {
                        select.appendChild(newOption);
                    }
                }
            });
            
            // Atualizar a lista de unidades disponíveis para todos os registros
            if (allSolicitacoes) {
                const unidades = [...new Set(allSolicitacoes.map(s => s.unidade).filter(Boolean))];
                if (!unidades.includes(unidade)) {
                    unidades.push(unidade);
                    console.log(`Unidade "${unidade}" adicionada à lista de unidades disponíveis`);
                }
            }
        }

        // Função para mostrar modal de confirmação
        function mostrarModalConfirmacaoDisparo() {
            return new Promise((resolve) => {
                const nome = prompt('Digite um nome para este disparo:');
                if (!nome || nome.trim() === '') {
                    resolve(null);
                    return;
                }

                const descricao = prompt('Digite uma descrição (opcional):') || '';
                
                const confirmar = confirm(`Confirma a criação do disparo "${nome}" com ${selectedSolicitacoes.size} solicitações?`);
                
                if (confirmar) {
                    resolve({
                        nome: nome.trim(),
                        descricao: descricao.trim()
                    });
                } else {
                    resolve(null);
                }
            });
        }

        // ============ FUNCIONALIDADE ATUALIZAR LISTA ============

        let updateSourceId = null;
        let selectedFileModal = null;

        // Abrir modal para atualizar lista
        function atualizarLista(sourceId, sourceName) {
            updateSourceId = sourceId;
            document.getElementById('modalAtualizarListaNome').textContent = sourceName;
            
            // Reset modal state
            resetModalState();
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalAtualizarLista'));
            modal.show();
            
            // Setup event listeners para o modal de upload
            setupUploadModalEventListeners();
        }

        // Reset estado do modal
        function resetModalState() {
            selectedFileModal = null;
            document.getElementById('fileInputModal').value = '';
            document.getElementById('fileInfoModal').classList.add('d-none');
            document.getElementById('progressContainerModal').classList.add('d-none');
            document.getElementById('resultsModal').classList.add('d-none');
            document.getElementById('errorModal').classList.add('d-none');
            document.getElementById('processModalBtn').classList.add('d-none');
            document.getElementById('uploadAreaModal').style.display = 'block';
        }

        // Setup event listeners do modal de upload
        function setupUploadModalEventListeners() {
            const selectFileBtn = document.getElementById('selectFileModalBtn');
            const fileInput = document.getElementById('fileInputModal');
            const processBtn = document.getElementById('processModalBtn');
            const uploadArea = document.getElementById('uploadAreaModal');

            // Clique no botão de selecionar arquivo
            selectFileBtn.onclick = () => fileInput.click();

            // Mudança de arquivo
            fileInput.onchange = (e) => handleFileSelectionModal(e.target.files[0]);

            // Drag and drop
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-primary');
            };

            uploadArea.ondragleave = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-primary');
            };

            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-primary');
                const file = e.dataTransfer.files[0];
                if (file) handleFileSelectionModal(file);
            };

            // Processar arquivo
            processBtn.onclick = () => processFileModal();
        }

        // Tratar seleção de arquivo no modal
        function handleFileSelectionModal(file) {
            if (!file) return;

            // Validar tipo de arquivo
            if (file.type !== 'application/pdf') {
                mostrarToast('Erro: Apenas arquivos PDF são aceitos', 'danger');
                return;
            }

            // Validar tamanho (50MB)
            if (file.size > 50 * 1024 * 1024) {
                mostrarToast('Erro: Arquivo muito grande. Limite de 50MB', 'danger');
                return;
            }

            selectedFileModal = file;

            // Mostrar informações do arquivo
            document.getElementById('fileNameModal').textContent = file.name;
            document.getElementById('fileSizeModal').textContent = formatFileSize(file.size);
            document.getElementById('fileInfoModal').classList.remove('d-none');
            document.getElementById('processModalBtn').classList.remove('d-none');
            document.getElementById('uploadAreaModal').style.display = 'none';
        }

        // Remover arquivo selecionado
        function removeFileModal() {
            selectedFileModal = null;
            document.getElementById('fileInputModal').value = '';
            document.getElementById('fileInfoModal').classList.add('d-none');
            document.getElementById('processModalBtn').classList.add('d-none');
            document.getElementById('uploadAreaModal').style.display = 'block';
        }

        // Processar arquivo e atualizar lista
        async function processFileModal() {
            if (!selectedFileModal || !updateSourceId) return;

            const progressContainer = document.getElementById('progressContainerModal');
            const progressBar = document.getElementById('progressBarModal');
            const progressText = document.getElementById('progressTextModal');
            const processBtn = document.getElementById('processModalBtn');

            try {
                // Mostrar progresso
                progressContainer.classList.remove('d-none');
                processBtn.disabled = true;

                // Preparar FormData
                const formData = new FormData();
                formData.append('file', selectedFileModal); // Nome correto do campo
                formData.append('sourceId', updateSourceId); // Informar que é uma atualização

                console.log('📤 Enviando arquivo:', selectedFileModal.name);
                console.log('📋 Source ID:', updateSourceId);
                console.log('📊 Tamanho do arquivo:', selectedFileModal.size);

                // Simular progresso durante upload
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                }, 500);

                console.log('🌐 Fazendo fetch para /api/pdf-extractor/upload');
                // Fazer upload
                const response = await fetch('/api/pdf-extractor/upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('📨 Resposta recebida:', response.status, response.statusText);

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = '100%';

                if (response.ok) {
                    const result = await response.json();
                    
                    // Mostrar sucesso
                    document.getElementById('resultsTextModal').textContent = 
                        `${result.registros_inseridos || 0} novos registros adicionados à lista!`;
                    document.getElementById('resultsModal').classList.remove('d-none');
                    
                    // Verificar se há avisos sobre duplicatas ou registros inválidos
                    if (result.warnings && result.warnings.length > 0) {
                        let warningMessages = [];
                        
                        result.warnings.forEach(warning => {
                            if (warning.type === 'duplicates') {
                                warningMessages.push(`⚠️ ${warning.message}:`);
                                warning.details.forEach(dup => {
                                    warningMessages.push(`• Solicitação ${dup.solicitacao} - ${dup.paciente} (${dup.procedimento})`);
                                });
                            } else if (warning.type === 'invalid') {
                                warningMessages.push(`⚠️ ${warning.message}:`);
                                warning.details.forEach(inv => {
                                    warningMessages.push(`• ${inv.paciente} - ${inv.motivo}`);
                                });
                            }
                        });
                        
                        if (warningMessages.length > 0) {
                            // Mostrar warnings em um alert detalhado
                            const warningText = warningMessages.join('\n');
                            setTimeout(() => {
                                alert(`Lista atualizada com avisos:\n\n${warningText}`);
                            }, 500);
                            
                            // Também mostrar um toast mais amigável
                            let toastMessage = `Lista atualizada! ${result.registros_inseridos} novos registros`;
                            if (result.warnings.find(w => w.type === 'duplicates')) {
                                const dupCount = result.warnings.find(w => w.type === 'duplicates').count;
                                toastMessage += ` (${dupCount} duplicados ignorados)`;
                            }
                            mostrarToast(toastMessage, 'warning');
                        } else {
                            mostrarToast('Lista atualizada com sucesso!', 'success');
                        }
                    } else {
                        mostrarToast('Lista atualizada com sucesso!', 'success');
                    }

                    // Recarregar sources após 2 segundos
                    setTimeout(() => {
                        loadSources();
                        bootstrap.Modal.getInstance(document.getElementById('modalAtualizarLista')).hide();
                    }, 2000);

                } else {
                    console.error('❌ Erro na resposta:', response.status, response.statusText);
                    let errorMessage = `Erro ${response.status}: ${response.statusText}`;
                    
                    try {
                        const error = await response.json();
                        errorMessage = error.message || errorMessage;
                        console.error('📄 Detalhes do erro:', error);
                    } catch (e) {
                        console.error('❌ Erro ao ler resposta JSON:', e);
                        const errorText = await response.text();
                        console.error('📄 Resposta em texto:', errorText);
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }

            } catch (error) {
                console.error('💥 Erro ao processar arquivo:', error);
                console.error('🔍 Stack trace:', error.stack);
                
                // Parar progresso
                clearInterval(progressInterval);
                progressContainer.classList.add('d-none');
                
                // Mostrar erro
                const errorMessage = error.message || 'Erro de conexão desconhecido';
                document.getElementById('errorTextModal').textContent = errorMessage;
                document.getElementById('errorModal').classList.remove('d-none');
                mostrarToast('Erro ao atualizar lista: ' + errorMessage, 'danger');
            } finally {
                processBtn.disabled = false;
            }
        }

        // Formatar tamanho do arquivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Função para excluir uma lista de disparo
        async function excluirLista(sourceId, sourceName) {
            if (!confirm(`Tem certeza que deseja excluir a lista "${sourceName}"?\n\nEsta ação não pode ser desfeita e excluirá todos os dados relacionados a esta lista.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/sources/${sourceId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    mostrarToast('Lista excluída com sucesso!', 'success');
                    
                    // Recarregar a lista de sources
                    setTimeout(() => {
                        loadSources();
                    }, 1000);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao excluir lista');
                }
            } catch (error) {
                console.error('Erro ao excluir lista:', error);
                mostrarToast('Erro ao excluir lista: ' + error.message, 'danger');
            }
        }
    </script>
</body>
</html>
